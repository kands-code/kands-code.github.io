<!DOCTYPE HTML>
<html
    lang="zh-Hans" 
    class="rust" 
    dir="ltr"> 
    <head>
        <title>Rust å­¦ä¹  final - Kevin Stephen&#x27;s Blogs</title> 
        <meta charset="UTF-8">
        <meta name="description" content="æ‰¾åˆ°å±äºè‡ªå·±çš„å…‰">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">
        
         
        <link rel="icon" href="../../favicon.svg">
         
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">

        <link rel="stylesheet"
            href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <link rel="stylesheet" href="../../theme/utils.css">

    </head>
    <body class="sidebar-visible no-js">
        <div id="body-container">
            <script>
                // è·å– root è·¯å¾„
                var path_to_root = "../../";
                // è·å–é»˜è®¤ä¸»é¢˜
                var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches
                    ? "ayu"
                    : "rust";
            </script>
            <script>
                try {
                    var theme = localStorage.getItem("mdbook-theme");
                    var sidebar = localStorage.getItem("mdbook-sidebar");

                    if (theme.startsWith('"') && theme.endsWith('"')) {
                        localStorage.setItem(
                            "mdbook-theme",
                            theme.slice(1, theme.length - 1).trim()
                        );
                    }

                    if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                        localStorage.setItem(
                            "mdbook-sidebar",
                            sidebar.slice(1, sidebar.length - 1).trim()
                        );
                    }
                } catch (e) {}
            </script>
            <script>
                var theme;
                try {
                    theme = localStorage.getItem("mdbook-theme");
                } catch (e) {}
                if (theme === null || theme === undefined) {
                    theme = default_theme;
                }
                var html = document.querySelector("html");
                html.classList.remove("rust");
                html.classList.add(theme);
                var body = document.querySelector("body");
                body.classList.remove("no-js");
                body.classList.add("js");
            </script>

            <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">
            <script>
                var body = document.querySelector("body");
                var sidebar = null;
                var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
                if (document.body.clientWidth >= 1080) {
                try {
                    sidebar = localStorage.getItem("mdbook-sidebar");
                } catch (e) {}
                    sidebar = sidebar || "visible";
                } else {
                    sidebar = "hidden";
                }
                sidebar_toggle.checked = sidebar === "visible";
                body.classList.remove("sidebar-visible");
                body.classList.add("sidebar-" + sidebar);
            </script>

            <nav id="sidebar" class="sidebar" aria-label="Table of contents">
                <div class="sidebar-scrollbox">
                    <ol class="chapter"><li class="chapter-item affix "><a href="../../init.html">Init</a></li><li class="chapter-item affix "><li class="part-title">Notes</li><li class="chapter-item expanded "><a href="../../notes/rust/index.html">Rust</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../notes/rust/20210605-rust-learn-01.html">Rust å­¦ä¹  01</a></li><li class="chapter-item "><a href="../../notes/rust/20210610-rust-learn-02.html">Rust å­¦ä¹  02</a></li><li class="chapter-item "><a href="../../notes/rust/20210824-rust-learn-03.html">Rust å­¦ä¹  03</a></li><li class="chapter-item "><a href="../../notes/rust/20211216-rust-learn-04.html">Rust å­¦ä¹  04</a></li><li class="chapter-item "><a href="../../notes/rust/20220512-rust-learn-05.html">Rust å­¦ä¹  05</a></li><li class="chapter-item "><a href="../../notes/rust/20220514-rust-learn-06.html">Rust å­¦ä¹  06</a></li><li class="chapter-item "><a href="../../notes/rust/20220520-rust-learn-07.html">Rust å­¦ä¹  07</a></li><li class="chapter-item "><a href="../../notes/rust/20220522-rust-learn-08.html">Rust å­¦ä¹  08</a></li><li class="chapter-item "><a href="../../notes/rust/20220523-rust-learn-09.html">Rust å­¦ä¹  09</a></li><li class="chapter-item "><a href="../../notes/rust/20220611-rust-learn-10.html">Rust å­¦ä¹  10</a></li><li class="chapter-item "><a href="../../notes/rust/20220619-rust-learn-11.html">Rust å­¦ä¹  11</a></li><li class="chapter-item "><a href="../../notes/rust/20220619-rust-learn-project-01.html">Rust å­¦ä¹  å®ä¾‹ 01</a></li><li class="chapter-item "><a href="../../notes/rust/20220623-rust-learn-12.html">Rust å­¦ä¹  12</a></li><li class="chapter-item "><a href="../../notes/rust/20220624-rust-learn-13.html">Rust å­¦ä¹  13</a></li><li class="chapter-item "><a href="../../notes/rust/20220925-rust-learn-14.html">Rust å­¦ä¹  14</a></li><li class="chapter-item "><a href="../../notes/rust/20220925-rust-learn-15.html">Rust å­¦ä¹  15</a></li><li class="chapter-item expanded "><a href="../../notes/rust/20221030-rust-learn-final.html" class="active">Rust å­¦ä¹  final</a></li><li class="chapter-item "><a href="../../notes/rust/20221030-rust-learn-project-02.html">Rust å­¦ä¹  å®ä¾‹ 02</a></li></ol></li><li class="chapter-item "><a href="../../notes/postgresql/index.html">PostgreSQL</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../notes/postgresql/20230502-psql-learn-01.html">PostgreSQL å­¦ä¹  01</a></li><li class="chapter-item "><a href="../../notes/postgresql/20231024-psql-learn-02.html">PostgreSQL å­¦ä¹  02</a></li><li class="chapter-item "><a href="../../notes/postgresql/20231110-psql-learn-03.html">PostgreSQL å­¦ä¹  03</a></li></ol></li><li class="chapter-item "><a href="../../notes/typechallenges/index.html">Type Challenges</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../notes/typechallenges/20230425-type-challenges-01.html">TypeScript ç±»å‹ä½“æ“ 01</a></li><li class="chapter-item "><a href="../../notes/typechallenges/20230428-type-challenges-02.html">TypeScript ç±»å‹ä½“æ“ 02</a></li></ol></li><li class="chapter-item "><li class="part-title">Miscellany</li><li class="chapter-item "><a href="../../miscellany/coding/index.html">Coding</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../miscellany/coding/20210604-scope-of-if-statement.html">if è¯­å¥çš„ä½œç”¨åŸŸ</a></li><li class="chapter-item "><a href="../../miscellany/coding/20221026-parse-math-in-c.html">C è¯­è¨€æ•°å­¦è§£æå™¨</a></li><li class="chapter-item "><a href="../../miscellany/coding/20231107-clash-system-agent.html">Cğœ†ash ç³»ç»Ÿä»£ç†</a></li><li class="chapter-item "><a href="../../miscellany/coding/20240228-use-giscus-in-mdbook.html">åœ¨ mdBook ä¸­ä½¿ç”¨ giscus æœåŠ¡</a></li></ol></li><li class="chapter-item "><a href="../../miscellany/study/index.html">Study</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../miscellany/study/20221108-qiskit-linear-algebra.html">qiskit çº¿æ€§ä»£æ•°</a></li><li class="chapter-item "><a href="../../miscellany/study/20221111-qiskit-Deutsch-Jozsa-algorithm.html">qiskit Deutsch-Jozsa ç®—æ³•</a></li></ol></li><li class="chapter-item "><a href="../../miscellany/life/index.html">Life</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../miscellany/life/20230411-about-life.html">è¯´è¯´ä»¥åçš„æ‰“ç®—ç½¢</a></li><li class="chapter-item "><a href="../../miscellany/life/20230715-about-job.html">è°ˆè°ˆæœ€è¿‘çš„å·¥ä½œçŠ¶æ€</a></li><li class="chapter-item "><a href="../../miscellany/life/20230915-end-of-summer.html">æš‘å‡ç»“æŸäº†</a></li><li class="chapter-item "><a href="../../miscellany/life/20231020-new-life.html">æ–°çš„ç”Ÿæ´»</a></li><li class="chapter-item "><a href="../../miscellany/life/20240120-busy-life.html">å¿™å¿™ç¢Œç¢Œ</a></li></ol></li><li class="chapter-item "><li class="part-title">About</li></ol>
                </div>
                <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                    <div class="sidebar-resize-indicator"></div>
                </div>
            </nav>

            <script>
                var sidebarScrollbox = document.querySelector("#sidebar .sidebar-scrollbox");
                sidebarScrollbox.addEventListener(
                    "click",
                    function (e) {
                        if (e.target.tagName === "A") {
                            sessionStorage.setItem("sidebar-scroll", sidebarScrollbox.scrollTop);
                        }
                    },
                    { passive: true }
                );
                var sidebarScrollTop = sessionStorage.getItem("sidebar-scroll");
                sessionStorage.removeItem("sidebar-scroll");
                if (sidebarScrollTop) {
                    // preserve sidebar scroll position when navigating via links within sidebar
                    sidebarScrollbox.scrollTop = sidebarScrollTop;
                } else {
                    // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                    var activeSection = document.querySelector("#sidebar .active");
                    if (activeSection) {
                        activeSection.scrollIntoView({ block: "center" });
                    }
                }
            </script>

            <div id="page-wrapper" class="page-wrapper">
                <div class="page">
                                        <div id="menu-bar-hover-placeholder"></div>
                    <div id="menu-bar" class="menu-bar sticky">
                        <div class="left-buttons">
                            <label id="sidebar-toggle" class="icon-button"
                                for="sidebar-toggle-anchor"
                                title="Toggle Table of Contents"
                                aria-label="Toggle Table of Contents"
                                aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </label>
                            <button id="theme-toggle" class="icon-button"
                                type="button" title="Change theme"
                                aria-label="Change theme" aria-haspopup="true"
                                aria-expanded="false"
                                aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup"
                                aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem"
                                        class="theme"
                                        id="light">Light</button></li>
                                <li role="none"><button role="menuitem"
                                        class="theme"
                                        id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem"
                                        class="theme"
                                        id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem"
                                        class="theme"
                                        id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem"
                                        class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            <button id="search-toggle" class="icon-button"
                                type="button" title="Search. (Shortkey: s)"
                                aria-label="Toggle Searchbar"
                                aria-expanded="false" aria-keyshortcuts="S"
                                aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                        </div>
                        <h1 class="menu-title">Kevin Stephen&#x27;s Blogs</h1>
                        <div class="right-buttons">
                            <a href="https://github.com/kands-code/kands-code.github.io"
                                title="Git repository"
                                aria-label="Git repository">
                                <i id="git-repository-button"
                                    class="fa fa-github"></i>
                            </a>
                            <a href="https://github.com/kands-code/kands-code.github.io/edit/repo-src/src/src/notes/rust/20221030-rust-learn-final.md"
                                title="Suggest an edit"
                                aria-label="Suggest an edit">
                                <i id="git-edit-button" class="fa fa-edit"></i>
                            </a>
                        </div>
                    </div>
                    <div id="search-wrapper" class="hidden">
                        <form id="searchbar-outer" class="searchbar-outer">
                            <input type="search" id="searchbar" name="searchbar"
                                placeholder="searching..."
                                aria-controls="searchresults-outer"
                                aria-describedby="searchresults-header">
                        </form>
                        <div id="searchresults-outer"
                            class="searchresults-outer hidden">
                            <div id="searchresults-header"
                                class="searchresults-header"></div>
                            <ul id="searchresults">
                            </ul>
                        </div>
                    </div>
                    <script>
                        document
                            .getElementById("sidebar-toggle")
                            .setAttribute("aria-expanded", sidebar === "visible");
                        document
                            .getElementById("sidebar")
                            .setAttribute("aria-hidden", sidebar !== "visible");
                        Array.from(document.querySelectorAll("#sidebar a")).forEach(function (link) {
                            link.setAttribute("tabIndex", sidebar === "visible" ? 0 : -1);
                        });
                    </script>

                    <div id="content" class="content">
                        <main><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="rust-å­¦ä¹ -final"><a class="header" href="#rust-å­¦ä¹ -final">Rust å­¦ä¹  Final</a></h1>
<p class="archive-time">archive time: 2022-10-30</p>
<p class="sp-comment">æ€»ç®—çœ‹å®Œæ¨æ—­å¤§ä½¬çš„ Rust è§†é¢‘äº†ï¼Œè¿™æ˜¯ Rust å­¦ä¹ çš„æœ€åä¸€ç¯‡äº†</p>
<ul>
<li><a href="#rust-%E7%9A%84-oop">Rust çš„ OOP</a>
<ul>
<li><a href="#%E5%B0%81%E8%A3%85">å°è£…</a></li>
<li><a href="#%E7%BB%A7%E6%89%BF">ç»§æ‰¿</a></li>
<li><a href="#%E5%A4%9A%E6%80%81">å¤šæ€</a></li>
<li><a href="#example">Example</a></li>
</ul>
</li>
<li><a href="#%E6%A8%A1%E5%BC%8F%E5%8C%B9%E9%85%8D">æ¨¡å¼åŒ¹é…</a></li>
<li><a href="#%E5%AE%8F">å®</a>
<ul>
<li><a href="#example-1">Example</a>
<ul>
<li><a href="#%E7%BB%84%E7%BB%87%E9%A1%B9%E7%9B%AE">ç»„ç»‡é¡¹ç›®</a></li>
<li><a href="#hello_macro">hello_macro</a></li>
<li><a href="#proc_test">proc_test</a></li>
<li><a href="#%E7%BB%93%E6%9E%9C">ç»“æœ</a></li>
</ul>
</li>
<li><a href="#%E5%B1%9E%E6%80%A7%E5%AE%8F">å±æ€§å®</a></li>
<li><a href="#%E5%87%BD%E6%95%B0%E5%AE%8F">å‡½æ•°å®</a></li>
</ul>
</li>
</ul>
<h2 id="rust-çš„-oop"><a class="header" href="#rust-çš„-oop">Rust çš„ OOP</a></h2>
<p>OOPï¼Œå³ <em>Object Oriented Programming</em>ï¼Œæ˜¯ä¸€ç§ç›®å‰æ¯”è¾ƒé€šç”¨çš„ <em>ç¼–ç¨‹èŒƒå¼</em> <sup class="footnote-reference"><a href="#1">1</a></sup></p>
<p>Rust ä¸­ï¼Œ<code>struct</code> å’Œ <code>enum</code> ä¸­åŒ…å«æ•°æ®ï¼ŒåŒæ—¶å¯ä»¥ä½¿ç”¨ <code>impl</code> æ¥æä¾›æ–¹æ³•æˆ–å‡½æ•°ï¼Œè¿™å¯ä»¥è¢«çœ‹æˆæ˜¯å¯¹è±¡çš„ä¸€ç§</p>
<p>è€Œ OOP æ€»ç»“ä¸‹æ¥å°±æ˜¯ä¸‰ç§ç‰¹ç‚¹ï¼Œ<strong>å°è£…</strong>ï¼Œ<strong>ç»§æ‰¿</strong> å’Œ <strong>å¤šæ€</strong></p>
<h3 id="å°è£…"><a class="header" href="#å°è£…">å°è£…</a></h3>
<p>Rust ä¸­ï¼Œå°è£…è¿™ä¸ªç‰¹æ€§åº”è¯¥æ˜¯æœ€å¥½ä½“ç°çš„äº†</p>
<p>Rust çš„ <code>struct</code> å’Œ <code>enum</code>ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯ <em>private</em> çš„ï¼Œåªæœ‰å†™äº† <code>pub</code> å…³é”®å­—æ‰èƒ½å¤Ÿä»å¤–éƒ¨è®¿é—®</p>
<p>è€Œä¸” Rust çš„ <code>enum</code> åœ¨æ ‡è®° <code>pub</code> åï¼Œæ¯ä¸ªå­—æ®µä¹Ÿå˜æˆå…¬å¼€çš„äº†</p>
<p>è€Œ <code>struct</code> åˆ™è¿˜éœ€è¦å°†éœ€è¦å…¬å¼€çš„å­—æ®µåŠ ä¸Š <code>pub</code> æ ‡è®°æ‰èƒ½å…¬å¼€</p>
<h3 id="ç»§æ‰¿"><a class="header" href="#ç»§æ‰¿">ç»§æ‰¿</a></h3>
<p>è¿™ç‚¹ï¼ŒRust ä¸­æ˜¯æ²¡æœ‰ç»§æ‰¿æœºåˆ¶çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>trait</code> æ¥åšåˆ°</p>
<p>æˆ‘ä»¬å¯ä»¥ä¸ºæˆ‘ä»¬çš„ <code>enum</code> æˆ–è€… <code>struct</code> å®ç° (å³ <code>impl</code>) æŸä¸ª <code>trait</code> æ¥å½“ä½œç»§æ‰¿äº†è¿™ä¸ª <code>trait</code></p>
<h3 id="å¤šæ€"><a class="header" href="#å¤šæ€">å¤šæ€</a></h3>
<p>å¤šæ€åœ¨ Rust é‡Œä¹Ÿæ˜¯é€šè¿‡ <code>trait</code> æ¥å®ç°çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>trait</code> çº¦æŸå’Œæ³›å‹æ¥åšåˆ° <sup class="footnote-reference"><a href="#2">2</a></sup></p>
<p>ç›¸å…³ RFC å¯ä»¥å‚è€ƒ <a href="https://rust-lang.github.io/rfcs/0034-bounded-type-parameters.html">è¿™é‡Œ</a></p>
<blockquote>
<p>è¿™ç§æ–¹æ¡ˆæˆ‘ä»¬è¿˜å¯ä»¥ç§°ä¸ºç»„åˆ <sup class="footnote-reference"><a href="#3">3</a></sup></p>
</blockquote>
<h3 id="example"><a class="header" href="#example">Example</a></h3>
<p>è¿™é‡Œæˆ‘ä»¬æ¥å®šä¹‰ä¸€ä¸ª <code>traie</code> å«åš <code>Draw</code></p>
<pre><code class="language-rust">pub trait Draw {
    fn draw(&amp;self);
}

pub struct Screen {
    pub components: Vec&lt;Box&lt;dyn Draw&gt;&gt;,
}

impl Screen {
    pub fn run(&amp;self) {
        for component in self.components.iter() {
            component.draw();
        }
    }
}

pub struct Button {
    pub width: u8,
    pub height: u8,
    pub label: String,
}

impl Draw for Button {
    fn draw(&amp;self) {
        println!(
            "Draw Button w: {} h: {} s: {}",
            self.width, self.height, self.label
        );
    }
}

pub struct SelectBox {
    pub width: u8,
    pub height: u8,
    pub options: Vec&lt;String&gt;,
    pub selected: bool,
}

impl Draw for SelectBox {
    fn draw(&amp;self) {
        println!(
            "Draw Selected state: {} w: {} h: {} s: {:?}",
            self.selected, self.width, self.height, self.options
        );
    }
}</code></pre>
<p><code>Draw</code> é‡Œé¢æœ‰ä¸€ä¸ªæ–¹æ³•éœ€è¦æˆ‘ä»¬æ¥å®ç° <code>draw()</code></p>
<p>è€Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>impl</code> ä¸º <code>Button</code> å’Œ <code>SelectBox</code> æ¥å®ç° <code>Draw</code></p>
<p>é…åˆ <code>Box&lt;dyn Draw&gt;</code>ï¼Œå°±å¥½åƒ <code>Button</code> å’Œ <code>SelectBox</code> ç»§æ‰¿äº† <code>Draw</code></p>
<p>ä½¿ç”¨ä¸€ä¸‹</p>
<pre><code class="language-rust">use rustex::rust::{self, Button, SelectBox};

fn main() {
    let s = rust::Screen {
        components: vec![
            Box::new(SelectBox {
                width: 75,
                height: 10,
                options: vec![String::from("Here")],
                selected: false,
            }),
            Box::new(Button {
                width: 50,
                height: 10,
                label: String::from("Ok"),
            }),
        ],
    };

    s.run();
}</code></pre>
<p>è¾“å‡ºå¦‚ä¸‹</p>
<pre><code class="language-text">Draw Selected state: false w: 75 h: 10 s: ["Here"]
Draw Button w: 50 h: 10 s: Ok
</code></pre>
<p>å¯ä»¥çœ‹åˆ°æ˜¯æ­£å¸¸æ‰§è¡Œäº†</p>
<h2 id="æ¨¡å¼åŒ¹é…"><a class="header" href="#æ¨¡å¼åŒ¹é…">æ¨¡å¼åŒ¹é…</a></h2>
<p>è¿™ä¸ªæˆ‘ä»¬å°±å¾ˆå¸¸è§äº†ï¼Œä¾‹å¦‚ <code>match</code>ï¼Œ<code>while let</code>ï¼Œ<code>if let</code> ä»¥åŠ <code>let</code> éƒ½å¯ä»¥ä½¿ç”¨æ¨¡å¼åŒ¹é…</p>
<pre><code class="language-rust">let x = Some(10);
if let Some(v) = x {
    println!("val in x is: {}", v);
}</code></pre>
<p><code>for</code> å¾ªç¯é‡Œé¢ä¹Ÿæœ‰æ¨¡å¼åŒ¹é…</p>
<pre><code class="language-rust">let vals = vec![1, 2, 3, 4];
for (i, v) in vals.iter().enumerate() {
    println!("{}: {}", i, v);
}</code></pre>
<p>å‡½æ•°å‚æ•°ä¹Ÿå¯ä»¥ä½¿ç”¨æ¨¡å¼åŒ¹é…</p>
<pre><code class="language-rust">fn print_point(&amp;(x, y): &amp;(f32, f32)) {
    println!("(x: {}, y: {})", x, y);
}</code></pre>
<p>æ¨¡å¼åŒ¹é…çš„è§„åˆ™å¯ä»¥å‚è€ƒ <a href="https://doc.rust-lang.org/reference/patterns.html">è¿™é‡Œ</a></p>
<h2 id="å®"><a class="header" href="#å®">å®</a></h2>
<p>å®ä¹Ÿæ˜¯ Rust çš„ä¸€å¤§ç‰¹è‰²</p>
<blockquote>
<p>the functionality and syntax of Rust can be extended with custom definitions called macros</p>
</blockquote>
<p>å®åœ¨ Rust ä¸­å¯ä»¥ç”¨åœ¨å¦‚ä¸‹åœºæ™¯ <sup class="footnote-reference"><a href="#4">4</a></sup></p>
<ul>
<li>å®ä½œä¸ºè¡¨è¾¾å¼æˆ–è¯­å¥</li>
<li>æ¨¡å¼ (patterns)</li>
<li>ç±»å‹ (types)</li>
<li>itemï¼ŒåŒ…æ‹¬ å…³è” item</li>
<li><code>macro_rules</code> çš„ transcribers</li>
<li>å¤–éƒ¨è¯­å¥å—</li>
</ul>
<p>ä¸‹é¢æ˜¯å®˜æ–¹ç»™å‡ºçš„ä¾‹å­</p>
<pre><code class="language-rust">// Used as an expression.
let x = vec![1,2,3];

// Used as a statement.
println!("Hello!");

// Used in a pattern.
macro_rules! pat {
    ($i:ident) =&gt; (Some($i))
}

if let pat!(x) = Some(1) {
    assert_eq!(x, 1);
}

// Used in a type.
macro_rules! Tuple {
    { $A:ty, $B:ty } =&gt; { ($A, $B) };
}

type N2 = Tuple!(i32, i32);

// Used as an item.
use std::cell::RefCell;
thread_local!(static FOO: RefCell&lt;u32&gt; = RefCell::new(1));

// Used as an associated item.
macro_rules! const_maker {
    ($t:ty, $v:tt) =&gt; { const CONST: $t = $v; };
}
trait T {
    const_maker!{i32, 7}
}

// Macro calls within macros.
macro_rules! example {
    () =&gt; { println!("Macro call in a macro!") };
}
// Outer macro `example` is expanded, then inner macro `println` is expanded.
example!();</code></pre>
<p>è€Œè¿‡ç¨‹å® <sup class="footnote-reference"><a href="#5">5</a></sup> å¯ä»¥åˆ†ä¸º <em>è¡ç”Ÿ (derive) å®</em>ï¼Œ<em>å±æ€§å®</em>ï¼Œ<em>å‡½æ•°å®</em>ï¼Œåˆ†åˆ«ç”¨åœ¨ <code>#[derive(xxx)]</code>ï¼Œè‡ªå®šä¹‰å±æ€§ï¼Œä»¥åŠä½œä¸ºå‡½æ•°è°ƒç”¨</p>
<h3 id="example-1"><a class="header" href="#example-1">Example</a></h3>
<p>è¿™é‡Œæˆ‘ç›´æ¥ç”¨ä¾‹å­æ¥å®è·µï¼Œä¸€èˆ¬ï¼Œéœ€è¦åŒ…å« <a href="https://crates.io/crates/syn">syn</a>, å’Œ <a href="https://crates.io/crates/quote">quote</a> è¿™ä¸¤ä¸ªåŒ…</p>
<h4 id="ç»„ç»‡é¡¹ç›®"><a class="header" href="#ç»„ç»‡é¡¹ç›®">ç»„ç»‡é¡¹ç›®</a></h4>
<p>é¡¹ç›®ç›®å½•ç»“æ„å¦‚ä¸‹</p>
<pre><code class="language-text">$ tree -L 1 .
.
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ hello_macro
â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â””â”€â”€ src
â””â”€â”€ proc_test
    â”œâ”€â”€ Cargo.toml
    â””â”€â”€ src
</code></pre>
<p>å³ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå·¥ä½œç©ºé—´ï¼ŒåŒ…å« <code>proc_test</code> å’Œ <code>hello_macro</code> ä¸¤ä¸ªåŒ…</p>
<pre><code class="language-toml">[workspace]

members = ["proc_test", "hello_macro"]
</code></pre>
<h4 id="hello_macro"><a class="header" href="#hello_macro">hello_macro</a></h4>
<p><code>hello_macro</code> æ˜¯æˆ‘ä»¬çš„æµ‹è¯•åŒ…ï¼Œå³æˆ‘ä»¬çš„ <code>trait</code> å’Œ <code>main</code> éƒ½åœ¨è¿™ä¸ªåŒ…é‡Œ</p>
<pre><code class="language-toml">[package]
name = "hello_macro"
version = "0.1.0"
edition = "2021"

[lib]
name = "hello_macro"
crate-type = ["rlib", "staticlib"]

[dependencies]
proc_test = { path = "../proc_test" }
</code></pre>
<p>åœ¨ <code>hello_macro/src/lib.rs</code> é‡Œï¼Œæˆ‘ä»¬ä»…éœ€è¦å®šä¹‰ <code>trait</code></p>
<pre><code class="language-rust">pub trait HelloMacro {
    fn hello_macro();
}</code></pre>
<h4 id="proc_test"><a class="header" href="#proc_test">proc_test</a></h4>
<p>æˆ‘ä»¬çš„å®å®šä¹‰åœ¨ <code>proc_test</code> é‡Œ</p>
<pre><code class="language-toml">[package]
name = "proc_test"
version = "0.1.0"
edition = "2021"

[lib]
name = "proc_test"
proc-macro = true

[dependencies]
syn = "1.0.103"
quote = "1.0.21"
</code></pre>
<p>é‡ç‚¹æ¥äº†ï¼Œæ¯ä¸ªåŒ…å«è¿‡ç¨‹å®çš„åŒ…å¿…å®šæ˜¯ <code>proc-macro</code> ç±»å‹çš„ <em>crate</em></p>
<p>è€Œ <code>proc-macro</code> ä¸å…è®¸å¯¼å‡ºé™¤äº†è¿‡ç¨‹å®ä»¥å¤–çš„å…¶ä»–å‡½æ•°æˆ–å®ï¼Œæ‰€ä»¥ä¸€èˆ¬éœ€è¦å•ç‹¬æˆåŒ…</p>
<p>åœ¨ <code>proc_test/src/lib.rs</code> ä¸‹å°±æ˜¯æˆ‘ä»¬ä¸»è¦çš„å†…å®¹äº†</p>
<pre><code class="language-rust">extern crate proc_macro;

use crate::proc_macro::TokenStream;
use quote::quote;
use syn;

#[proc_macro_derive(HelloMacro)]
pub fn hello_macro_derive(input: TokenStream) -&gt; TokenStream {
    let ast = syn::parse(input).unwrap();
    impl_hello_macro(&amp;ast)
}

fn impl_hello_macro(ast: &amp;syn::DeriveInput) -&gt; TokenStream {
    let name = &amp;ast.ident;
    let gen = quote! {
        impl HelloMacro for #name {
            fn hello_macro() {
                println!("Hello, Macro! My name is {}", stringify!(#name));
            }
        }
    };
    gen.into()
}</code></pre>
<p>é¦–å…ˆä½¿ç”¨ <code>extern crate proc_macro;</code> å°† <code>proc_macro</code> å¼•å…¥ <code>crate</code> å±‚çº§ï¼Œè€Œåå¯¼å…¥ <code>syn</code> å’Œ <code>quote::quote!</code></p>
<p>æˆ‘ä»¬è¿™é‡Œå†™çš„æ˜¯ä¸€ä¸ªè¡ç”Ÿå®ï¼Œæ‰€ä»¥ä½¿ç”¨ <code>#[proc_macro_derive(HelloMacro)]</code> æ ‡æ³¨ï¼Œè€Œæ‹¬å·é‡Œé¢å°±æ˜¯æˆ‘ä»¬è¦è¡ç”Ÿçš„ <code>trait</code> äº†</p>
<p>ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>syn::parse</code> å°†ä¼ å…¥çš„å†…å®¹ï¼Œä¸€èˆ¬å°±æ˜¯éœ€è¦è¡ç”Ÿçš„ <code>struct</code> æˆ–è€… <code>enum</code> çš„ä»£ç ï¼Œè§£æä¸º <strong><em>AST</em></strong> å½¢å¼ <sup class="footnote-reference"><a href="#6">6</a></sup></p>
<p>è€Œåå°†è§£æå¥½çš„å†…å®¹ä¼ ç»™ <code>impl_hello_macro</code></p>
<p>åœ¨ <code>impl_hello_macro</code> é‡Œï¼Œæˆ‘ä»¬ä» <strong>AST</strong> ä¸­è·å–åˆ°æ ‡è¯†ç¬¦çš„åç§° <code>ident</code>ï¼Œåœ¨ <code>quote!</code> é‡Œæˆ‘ä»¬å®ç°äº† <code>hello_macro()</code></p>
<p>æœ€åå°†å®ç°çš„å†…å®¹è¿”å›ï¼Œè¿™å°±å®Œæˆäº†è¡ç”Ÿè¿‡ç¨‹</p>
<h4 id="ç»“æœ"><a class="header" href="#ç»“æœ">ç»“æœ</a></h4>
<p>æˆ‘ä»¬å°†æµ‹è¯•ä»£ç æ”¾åœ¨ <code>hello_macro</code> åŒ…ä¸‹ï¼Œåœ¨ <code>hello_macro/src/main.rs</code> é‡Œï¼Œå°±æ˜¯æˆ‘ä»¬è¦åšåˆ°çš„æ•ˆæœäº†</p>
<pre><code class="language-rust">use hello_macro::HelloMacro;
use proc_test::HelloMacro;

#[derive(HelloMacro)]
struct Pank;

fn main() {
    Pank::hello_macro();
}</code></pre>
<p>æˆ‘ä»¬åœ¨å·¥ä½œç©ºé—´ç›®å½•ä¸‹ä½¿ç”¨ <code>cargo run -p hello_macro</code> å³å¯çœ‹åˆ°æ•ˆæœ</p>
<pre><code class="language-text">Hello, Macro! My name is Pank
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>hello_macro</code> æˆåŠŸè¾“å…¥äº† stuct çš„åç§° <code>Pank</code></p>
<h3 id="å±æ€§å®"><a class="header" href="#å±æ€§å®">å±æ€§å®</a></h3>
<p>å±æ€§å®çš„ç”¨æ³•ä¸€èˆ¬æ˜¯ <code>#[macro_name(params)]</code>ï¼Œå®šä¹‰æ–¹å¼ä¸º</p>
<pre><code class="language-rust">#[proc_macro_attribute]
pub fn macro_name(attr: TokenStream, item: TokenStream) -&gt; TokenStream {
    ...
}</code></pre>
<p>ç¬¬ä¸€ä¸ª <code>attr</code> å°±æ˜¯æˆ‘ä»¬ä½¿ç”¨å®çš„æ—¶å€™çš„å‚æ•° <code>params</code>ï¼Œè€Œåé¢çš„ <code>item</code> å°±æ˜¯æˆ‘ä»¬è¦ä¿®é¥°çš„å‡½æ•°</p>
<h3 id="å‡½æ•°å®"><a class="header" href="#å‡½æ•°å®">å‡½æ•°å®</a></h3>
<p>å‡½æ•°å®å°±æ˜¯ç±»ä¼¼å‡½æ•°çš„å®ï¼Œä¾‹å­å°±æ˜¯ <code>format!</code> å’Œ <code>println!</code>ï¼Œä¾‹å¦‚</p>
<pre><code class="language-rust">let s = sql!(SELECT * FROM posts WHERE id=1);</code></pre>
<p>è€Œå®šä¹‰æ–¹å¼å¦‚ä¸‹</p>
<pre><code class="language-rust">#[proc_macro]
pub fn sql(input: TokenStream) -&gt; TokenStream {
    ...
}</code></pre>
<hr />
<p>å¥½ï¼Œåˆ°è¿™é‡Œï¼ŒRust å¤§è‡´å†…å®¹å°±ç®—æ˜¯è¿‡äº†ä¸€éäº†ï¼Œä¸è¿‡å…·ä½“ä½¿ç”¨è¿˜æ˜¯éœ€è¦å¥½å¥½çœ‹æ–‡æ¡£ï¼Œå†™ä»£ç </p>
<p>å†™ Rust å°±æ˜¯å’Œæ‰€æœ‰æƒåš <del>æ–—äº‰</del> æœ‹å‹ï¼Œåé¢å¤§éƒ¨åˆ†å°±æ˜¯å®ä¾‹å’Œå°æç¤ºäº†ï¼ŒåŠ æ²¹å§ï¼</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>Wikipedia.Programming Paradigm [DB/OL].
<a href="https://en.wikipedia.org/wiki/Programming_paradigm">https://en.wikipedia.org/wiki/Programming_paradigm</a>,
2022-10-28/2022-10-30</p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p>Wikipedia.Bounded Quantification [DB/OL].
<a href="https://en.wikipedia.org/wiki/Bounded_quantification">https://en.wikipedia.org/wiki/Bounded_quantification</a>,
2021-11-10/2022-10-30</p>
</div>
<div class="footnote-definition" id="3"><sup class="footnote-definition-label">3</sup>
<p>Rust Reference.Type Layout [S/OL].
<a href="https://doc.rust-lang.org/reference/type-layout.html">https://doc.rust-lang.org/reference/type-layout.html</a>,
2022-10-30</p>
</div>
<div class="footnote-definition" id="4"><sup class="footnote-definition-label">4</sup>
<p>Rust Reference.Macro [S/OL].
<a href="https://doc.rust-lang.org/reference/macros.html">https://doc.rust-lang.org/reference/macros.html</a>,
2022-10-30</p>
</div>
<div class="footnote-definition" id="5"><sup class="footnote-definition-label">5</sup>
<p>Rust Docs.proc_macro [S/OL].
<a href="https://doc.rust-lang.org/proc_macro/">https://doc.rust-lang.org/proc_macro/</a>,
2022-10-30</p>
</div>
<div class="footnote-definition" id="6"><sup class="footnote-definition-label">6</sup>
<p>Wikipedia.Abstract Syntax Tree [DB/OL].
<a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">https://en.wikipedia.org/wiki/Abstract_syntax_tree</a>,
2022-8-10/2022-10-30</p>
</div>
</main>
                        <nav class="nav-wrapper" aria-label="Page navigation">
                            <a rel="prev" href="../../notes/rust/20220925-rust-learn-15.html"
                                class="mobile-nav-chapters previous"
                                title="Previous chapter"
                                aria-label="Previous chapter"
                                aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next prefetch"
                                href="../../notes/rust/20221030-rust-learn-project-02.html"
                                class="mobile-nav-chapters next"
                                title="Next chapter" aria-label="Next chapter"
                                aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                            <div style="clear: both"></div>
                        </nav>
                    </div>
                </div>
                <div class="giscus-comment">
                </div>
                <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../notes/rust/20220925-rust-learn-15.html"
                        class="nav-chapters previous" title="Previous chapter"
                        aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next prefetch" href="../../notes/rust/20221030-rust-learn-project-02.html"
                        class="nav-chapters next" title="Next chapter"
                        aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                </nav>
            </div>
            <script>
                window.playground_copyable = true;
            </script>
            <script src="../../elasticlunr.min.js"></script>
            <script src="../../mark.min.js"></script>
            <script src="../../searcher.js"></script>
            <script src="../../clipboard.min.js"></script>
            <script src="../../highlight.js"></script>
            <script src="../../book.js"></script>
            <script src="../../theme/giscus.js"></script>
        </div>
    </body>
</html>
