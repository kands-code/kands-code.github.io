<!DOCTYPE HTML>
<html
    lang="zh-Hans" 
    class="rust" 
    dir="ltr"> 
    <head>
        <title>Rust å­¦ä¹  å®ä¾‹ 02 - Kevin Stephen&#x27;s Blogs</title> 
        <meta charset="UTF-8">
        <meta name="description" content="æ‰¾åˆ°å±äºè‡ªå·±çš„å…‰">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">
        
         
        <link rel="icon" href="../../favicon.svg">
         
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">

        <link rel="stylesheet"
            href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <link rel="stylesheet" href="../../theme/utils.css">

    </head>
    <body class="sidebar-visible no-js">
        <div id="body-container">
            <script>
                // è·å– root è·¯å¾„
                var path_to_root = "../../";
                // è·å–é»˜è®¤ä¸»é¢˜
                var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches
                    ? "ayu"
                    : "rust";
            </script>
            <script>
                try {
                    var theme = localStorage.getItem("mdbook-theme");
                    var sidebar = localStorage.getItem("mdbook-sidebar");

                    if (theme.startsWith('"') && theme.endsWith('"')) {
                        localStorage.setItem(
                            "mdbook-theme",
                            theme.slice(1, theme.length - 1).trim()
                        );
                    }

                    if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                        localStorage.setItem(
                            "mdbook-sidebar",
                            sidebar.slice(1, sidebar.length - 1).trim()
                        );
                    }
                } catch (e) {}
            </script>
            <script>
                var theme;
                try {
                    theme = localStorage.getItem("mdbook-theme");
                } catch (e) {}
                if (theme === null || theme === undefined) {
                    theme = default_theme;
                }
                var html = document.querySelector("html");
                html.classList.remove("rust");
                html.classList.add(theme);
                var body = document.querySelector("body");
                body.classList.remove("no-js");
                body.classList.add("js");
            </script>

            <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">
            <script>
                var body = document.querySelector("body");
                var sidebar = null;
                var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
                if (document.body.clientWidth >= 1080) {
                try {
                    sidebar = localStorage.getItem("mdbook-sidebar");
                } catch (e) {}
                    sidebar = sidebar || "visible";
                } else {
                    sidebar = "hidden";
                }
                sidebar_toggle.checked = sidebar === "visible";
                body.classList.remove("sidebar-visible");
                body.classList.add("sidebar-" + sidebar);
            </script>

            <nav id="sidebar" class="sidebar" aria-label="Table of contents">
                <div class="sidebar-scrollbox">
                    <ol class="chapter"><li class="chapter-item "><a href="../../init.html">Init</a></li><li class="chapter-item "><a href="../../about.html">About</a></li><li class="chapter-item affix "><li class="part-title">Notes</li><li class="chapter-item expanded "><a href="../../notes/rust/index.html">Rust</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../notes/rust/20210605-rust-learn-01.html">Rust å­¦ä¹  01</a></li><li class="chapter-item "><a href="../../notes/rust/20210610-rust-learn-02.html">Rust å­¦ä¹  02</a></li><li class="chapter-item "><a href="../../notes/rust/20210824-rust-learn-03.html">Rust å­¦ä¹  03</a></li><li class="chapter-item "><a href="../../notes/rust/20211216-rust-learn-04.html">Rust å­¦ä¹  04</a></li><li class="chapter-item "><a href="../../notes/rust/20220512-rust-learn-05.html">Rust å­¦ä¹  05</a></li><li class="chapter-item "><a href="../../notes/rust/20220514-rust-learn-06.html">Rust å­¦ä¹  06</a></li><li class="chapter-item "><a href="../../notes/rust/20220520-rust-learn-07.html">Rust å­¦ä¹  07</a></li><li class="chapter-item "><a href="../../notes/rust/20220522-rust-learn-08.html">Rust å­¦ä¹  08</a></li><li class="chapter-item "><a href="../../notes/rust/20220523-rust-learn-09.html">Rust å­¦ä¹  09</a></li><li class="chapter-item "><a href="../../notes/rust/20220611-rust-learn-10.html">Rust å­¦ä¹  10</a></li><li class="chapter-item "><a href="../../notes/rust/20220619-rust-learn-11.html">Rust å­¦ä¹  11</a></li><li class="chapter-item "><a href="../../notes/rust/20220619-rust-learn-project-01.html">Rust å­¦ä¹  å®ä¾‹ 01</a></li><li class="chapter-item "><a href="../../notes/rust/20220623-rust-learn-12.html">Rust å­¦ä¹  12</a></li><li class="chapter-item "><a href="../../notes/rust/20220624-rust-learn-13.html">Rust å­¦ä¹  13</a></li><li class="chapter-item "><a href="../../notes/rust/20220925-rust-learn-14.html">Rust å­¦ä¹  14</a></li><li class="chapter-item "><a href="../../notes/rust/20220925-rust-learn-15.html">Rust å­¦ä¹  15</a></li><li class="chapter-item "><a href="../../notes/rust/20221030-rust-learn-final.html">Rust å­¦ä¹  final</a></li><li class="chapter-item expanded "><a href="../../notes/rust/20221030-rust-learn-project-02.html" class="active">Rust å­¦ä¹  å®ä¾‹ 02</a></li></ol></li><li class="chapter-item "><a href="../../notes/postgresql/index.html">PostgreSQL</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../notes/postgresql/20230502-psql-learn-01.html">PostgreSQL å­¦ä¹  01</a></li><li class="chapter-item "><a href="../../notes/postgresql/20231024-psql-learn-02.html">PostgreSQL å­¦ä¹  02</a></li><li class="chapter-item "><a href="../../notes/postgresql/20231110-psql-learn-03.html">PostgreSQL å­¦ä¹  03</a></li></ol></li><li class="chapter-item "><a href="../../notes/typechallenges/index.html">Type Challenges</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../notes/typechallenges/20230425-type-challenges-01.html">TypeScript ç±»å‹ä½“æ“ 01</a></li><li class="chapter-item "><a href="../../notes/typechallenges/20230428-type-challenges-02.html">TypeScript ç±»å‹ä½“æ“ 02</a></li></ol></li><li class="chapter-item "><li class="part-title">Miscellany</li><li class="chapter-item "><a href="../../miscellany/coding/index.html">Coding</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../miscellany/coding/20210604-scope-of-if-statement.html">if è¯­å¥çš„ä½œç”¨åŸŸ</a></li><li class="chapter-item "><a href="../../miscellany/coding/20221026-parse-math-in-c.html">C è¯­è¨€æ•°å­¦è§£æå™¨</a></li><li class="chapter-item "><a href="../../miscellany/coding/20231107-clash-system-agent.html">Cğœ†ash ç³»ç»Ÿä»£ç†</a></li><li class="chapter-item "><a href="../../miscellany/coding/20240228-use-giscus-in-mdbook.html">åœ¨ mdBook ä¸­ä½¿ç”¨ giscus æœåŠ¡</a></li></ol></li><li class="chapter-item "><a href="../../miscellany/study/index.html">Study</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../miscellany/study/20221108-qiskit-linear-algebra.html">qiskit çº¿æ€§ä»£æ•°</a></li><li class="chapter-item "><a href="../../miscellany/study/20221111-qiskit-Deutsch-Jozsa-algorithm.html">qiskit Deutsch-Jozsa ç®—æ³•</a></li></ol></li><li class="chapter-item "><a href="../../miscellany/life/index.html">Life</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../miscellany/life/20230411-about-life.html">è¯´è¯´ä»¥åçš„æ‰“ç®—ç½¢</a></li><li class="chapter-item "><a href="../../miscellany/life/20230715-about-job.html">è°ˆè°ˆæœ€è¿‘çš„å·¥ä½œçŠ¶æ€</a></li><li class="chapter-item "><a href="../../miscellany/life/20230915-end-of-summer.html">æš‘å‡ç»“æŸäº†</a></li><li class="chapter-item "><a href="../../miscellany/life/20231020-new-life.html">æ–°çš„ç”Ÿæ´»</a></li><li class="chapter-item "><a href="../../miscellany/life/20240120-busy-life.html">å¿™å¿™ç¢Œç¢Œ</a></li></ol></li></ol>
                </div>
                <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                    <div class="sidebar-resize-indicator"></div>
                </div>
            </nav>

            <script>
                var sidebarScrollbox = document.querySelector("#sidebar .sidebar-scrollbox");
                sidebarScrollbox.addEventListener(
                    "click",
                    function (e) {
                        if (e.target.tagName === "A") {
                            sessionStorage.setItem("sidebar-scroll", sidebarScrollbox.scrollTop);
                        }
                    },
                    { passive: true }
                );
                var sidebarScrollTop = sessionStorage.getItem("sidebar-scroll");
                sessionStorage.removeItem("sidebar-scroll");
                if (sidebarScrollTop) {
                    // preserve sidebar scroll position when navigating via links within sidebar
                    sidebarScrollbox.scrollTop = sidebarScrollTop;
                } else {
                    // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                    var activeSection = document.querySelector("#sidebar .active");
                    if (activeSection) {
                        activeSection.scrollIntoView({ block: "center" });
                    }
                }
            </script>

            <div id="page-wrapper" class="page-wrapper">
                <div class="page">
                                        <div id="menu-bar-hover-placeholder"></div>
                    <div id="menu-bar" class="menu-bar sticky">
                        <div class="left-buttons">
                            <label id="sidebar-toggle" class="icon-button"
                                for="sidebar-toggle-anchor"
                                title="Toggle Table of Contents"
                                aria-label="Toggle Table of Contents"
                                aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </label>
                            <button id="theme-toggle" class="icon-button"
                                type="button" title="Change theme"
                                aria-label="Change theme" aria-haspopup="true"
                                aria-expanded="false"
                                aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup"
                                aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem"
                                        class="theme"
                                        id="light">Light</button></li>
                                <li role="none"><button role="menuitem"
                                        class="theme"
                                        id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem"
                                        class="theme"
                                        id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem"
                                        class="theme"
                                        id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem"
                                        class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            <button id="search-toggle" class="icon-button"
                                type="button" title="Search. (Shortkey: s)"
                                aria-label="Toggle Searchbar"
                                aria-expanded="false" aria-keyshortcuts="S"
                                aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                        </div>
                        <h1 class="menu-title">Kevin Stephen&#x27;s Blogs</h1>
                        <div class="right-buttons">
                            <a href="https://github.com/kands-code/kands-code.github.io"
                                title="Git repository"
                                aria-label="Git repository">
                                <i id="git-repository-button"
                                    class="fa fa-github"></i>
                            </a>
                            <a href="https://github.com/kands-code/kands-code.github.io/edit/repo-src/src/src/notes/rust/20221030-rust-learn-project-02.md"
                                title="Suggest an edit"
                                aria-label="Suggest an edit">
                                <i id="git-edit-button" class="fa fa-edit"></i>
                            </a>
                        </div>
                    </div>
                    <div id="search-wrapper" class="hidden">
                        <form id="searchbar-outer" class="searchbar-outer">
                            <input type="search" id="searchbar" name="searchbar"
                                placeholder="searching..."
                                aria-controls="searchresults-outer"
                                aria-describedby="searchresults-header">
                        </form>
                        <div id="searchresults-outer"
                            class="searchresults-outer hidden">
                            <div id="searchresults-header"
                                class="searchresults-header"></div>
                            <ul id="searchresults">
                            </ul>
                        </div>
                    </div>
                    <script>
                        document
                            .getElementById("sidebar-toggle")
                            .setAttribute("aria-expanded", sidebar === "visible");
                        document
                            .getElementById("sidebar")
                            .setAttribute("aria-hidden", sidebar !== "visible");
                        Array.from(document.querySelectorAll("#sidebar a")).forEach(function (link) {
                            link.setAttribute("tabIndex", sidebar === "visible" ? 0 : -1);
                        });
                    </script>

                    <div id="content" class="content">
                        <main><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="rust-å­¦ä¹ -å®ä¾‹-02"><a class="header" href="#rust-å­¦ä¹ -å®ä¾‹-02">Rust å­¦ä¹  å®ä¾‹ 02</a></h1>
<p class="archive-time">archive time: 2022-10-30</p>
<p class="sp-comment">è¿™æ˜¯æ¨æ—­å¤§ä½¬è§†é¢‘é‡Œæœ€åçš„é‚£ä¸ªä¾‹å­ï¼Œä¸€ä¸ªç®€å•çš„ Web æœåŠ¡å™¨</p>
<ul>
<li><a href="#%E9%9C%80%E6%B1%82">éœ€æ±‚</a></li>
<li><a href="#%E5%8D%95%E7%BA%BF%E7%A8%8B%E5%AE%9E%E7%8E%B0">å•çº¿ç¨‹å®ç°</a></li>
<li><a href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AE%9E%E7%8E%B0">å¤šçº¿ç¨‹å®ç°</a></li>
</ul>
<h2 id="éœ€æ±‚"><a class="header" href="#éœ€æ±‚">éœ€æ±‚</a></h2>
<p>çœ‹çœ‹è¿™ä¸ªé¡¹ç›®éœ€æ±‚</p>
<ul>
<li>åœ¨ socket ä¸Šç›‘å¬ TCP è¿æ¥</li>
<li>è§£æå°‘é‡ HTTP è¯·æ±‚</li>
<li>åˆ›å»ºä¸€ä¸ªåˆé€‚çš„ HTTP å“åº”</li>
<li>ä½¿ç”¨çº¿ç¨‹æ± æ”¹è¿›æœåŠ¡å™¨çš„ååé‡</li>
</ul>
<p>å¯è§è¿˜æ˜¯å¾ˆå…¨é¢çš„</p>
<h2 id="å•çº¿ç¨‹å®ç°"><a class="header" href="#å•çº¿ç¨‹å®ç°">å•çº¿ç¨‹å®ç°</a></h2>
<p>é¦–å…ˆçœ‹çœ‹å•çº¿ç¨‹çš„å®ç°</p>
<pre><code class="language-rust">use std::{
    fs,
    io::{Read, Write},
    net::{TcpListener, TcpStream},
};

fn main() {
    const PORT: usize = 7878;
    let listener = TcpListener::bind(format!("127.0.0.1:{}", PORT)).unwrap();

    for stream in listener.incoming() {
        let stream = stream.unwrap();
        handle_connection(stream);
    }
}

fn handle_connection(mut stream: TcpStream) {
    let mut buffer = [0; 512];
    stream.read(&amp;mut buffer).unwrap();
    let get = b"GET / HTTP/1.1\r\n";

    let (status, page_path) = if buffer.starts_with(get) {
        ("HTTP/1.1 200 OK\r\n\r\n", "simple_server/web/index.html")
    } else {
        (
            "HTTP/1.1 404 NOT FOUND\r\n\r\n",
            "simple_server/web/404.html",
        )
    };
    stream
        .write(format!("{}{}", status, fs::read_to_string(page_path).unwrap(),).as_bytes())
        .unwrap();
    stream.flush().unwrap();
}</code></pre>
<p>è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>std::net::TcpListener</code> çš„ <code>bind()</code> æ–¹æ³•ç»‘å®š <code>7878</code><sup class="footnote-reference"><a href="#1">1</a></sup> ç«¯å£</p>
<p><code>TcpListener</code> ä¼šç›‘å¬è¿™ä¸ªç«¯å£æ‰€æœ‰çš„ TCP æ¶ˆæ¯ï¼Œè¿™é‡Œä½¿ç”¨ for å¾ªç¯å°†æ¶ˆæ¯ä»¥ <code>stream</code> è¯»å–ï¼Œäº¤ç»™ <code>handle_connection</code> å¤„ç†æ¶ˆæ¯</p>
<p>åœ¨ <code>handle_connection</code> é‡Œï¼Œä½¿ç”¨ <code>std::io::Read</code> çš„ <code>read()</code> æ–¹æ³•å°† <code>stream</code> æ•°æ®è¯»å–åˆ° <code>buffer</code> é‡Œ</p>
<p>æ³¨æ„åˆ°ï¼Œè¿™é‡Œæ¶ˆæ¯ç”± <code>u8</code> æ ¼å¼ä¼ é€’ï¼Œå¦‚éœ€è¦è¯»å–æ¶ˆæ¯å†…å®¹ï¼Œéœ€è¦ä½¿ç”¨ <code>String::from_utf8_lossy()</code> æ–¹æ³•è¿›è¡Œä¼ é€’</p>
<p>è€Œåæˆ‘ä»¬åˆ¤æ–­è¯·æ±‚æ˜¯å¦æ˜¯è·å–æ ¹ç›®å½• <code>/</code> çš„é¡µé¢ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å›æˆ‘ä»¬å‡†å¤‡å¥½çš„ <code>index.html</code> é¡µé¢ï¼Œå…¶ä»–æ¶ˆæ¯åˆ™è¿”å› <code>404.html</code> é¡µé¢</p>
<p>è¿”å›éœ€è¦ä½¿ç”¨ <code>stream</code> é‡Œçš„ <code>write()</code> æ–¹æ³•å†™å…¥ï¼Œæœ€åä½¿ç”¨ <code>flush()</code> åˆ·æ–°ï¼Œç¡®ä¿æ¶ˆæ¯ä¼ é€’å®Œæ¯•</p>
<h2 id="å¤šçº¿ç¨‹å®ç°"><a class="header" href="#å¤šçº¿ç¨‹å®ç°">å¤šçº¿ç¨‹å®ç°</a></h2>
<p>å¦‚æœè¦æ”¹ä¸ºå¤šçº¿ç¨‹ï¼Œåˆ™éœ€è¦ä½¿ç”¨åˆ°çº¿ç¨‹æ± æŠ€æœ¯ï¼Œè¿™é‡Œï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸‹çº¿ç¨‹æ± </p>
<pre><code class="language-rust">use std::{
    sync::{mpsc, Arc, Mutex},
    thread,
};

type Job = Box&lt;dyn FnBox + Send + 'static&gt;;

enum Message {
    NewJob(Job),
    Terminate,
}

pub struct ThreadPool {
    workers: Vec&lt;Worker&gt;,
    sender: mpsc::Sender&lt;Message&gt;,
}

impl ThreadPool {
    pub fn new(size: usize) -&gt; ThreadPool {
        let mut workers = Vec::with_capacity(size);
        let (sender, reciver) = mpsc::channel();
        let reciver = Arc::new(Mutex::new(reciver));

        for id in 0..size {
            workers.push(Worker::new(id, Arc::clone(&amp;reciver)));
        }

        ThreadPool { workers, sender }
    }

    pub fn execute&lt;F&gt;(&amp;self, f: F)
    where
        F: FnOnce() + Send + 'static,
    {
        let job = Box::new(f);
        self.sender.send(Message::NewJob(job)).unwrap();
    }
}

impl Drop for ThreadPool {
    fn drop(&amp;mut self) {
        for _ in &amp;mut self.workers {
            self.sender.send(Message::Terminate).unwrap();
        }

        for worker in &amp;mut self.workers {
            println!("shuutting down worker {}", worker.id);

            if let Some(thread) = worker.thread.take() {
                thread.join().unwrap();
            }
        }
    }
}

pub struct Worker {
    id: usize,
    thread: Option&lt;thread::JoinHandle&lt;()&gt;&gt;,
}

trait FnBox {
    fn call_box(self: Box&lt;Self&gt;);
}

impl&lt;F: FnOnce()&gt; FnBox for F {
    fn call_box(self: Box&lt;Self&gt;) {
        (*self)()
    }
}

impl Worker {
    fn new(id: usize, receiver: Arc&lt;Mutex&lt;mpsc::Receiver&lt;Message&gt;&gt;&gt;) -&gt; Worker {
        let thread = thread::spawn(move || loop {
            let message = receiver.lock().unwrap().recv().unwrap();
            match message {
                Message::NewJob(job) =&gt; {
                    println!("Worker {} got a job, executing!", id);
                    job.call_box();
                }
                Message::Terminate =&gt; {
                    println!("Worker {} was told to terminate", id);
                    break;
                }
            }
        });

        Worker {
            id,
            thread: Some(thread),
        }
    }
}</code></pre>
<p>é¦–å…ˆï¼Œçº¿ç¨‹æ± è‡ªç„¶éœ€è¦å­˜å‚¨çº¿ç¨‹ï¼Œè¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>Vec&lt;Worker&gt;</code> æ¥å­˜å‚¨çº¿ç¨‹ï¼Œè¿™é‡Œçš„ <code>Worker</code> ç±»å‹å°±æ˜¯æˆ‘ä»¬ç”¨æ¥å¸®åŠ©æˆ‘ä»¬å¤„ç†çº¿ç¨‹çš„ç±»å‹</p>
<p>è€Œ <code>sender</code> æ˜¯ç”¨äºåˆ†å‘ä»»åŠ¡ï¼Œè¿™é‡Œçš„ â€œä»»åŠ¡â€ æˆ‘ä»¬ä½¿ç”¨ <code>Job</code> ç±»å‹æ¥è¡¨ç¤º</p>
<pre><code class="language-rust">type Job = Box&lt;dyn FnBox + Send + 'static&gt;;</code></pre>
<p>è‡³äº Worker å’Œ Job è¿™äº›åˆ™æ˜¯çº¿ç¨‹æ± å¸¸ç”¨æœ¯è¯­ï¼Œå¯ä»¥å‚è€ƒ <a href="https://en.wikipedia.org/wiki/Thread_pool">è¿™é‡Œ</a></p>
<p>åœ¨ Rust é‡Œï¼Œ<code>mpsc</code> æ˜¯å¤šä¸ªç”Ÿäº§è€…ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œå¯¹åº”è¿™é‡Œå°±æ˜¯ä¸€ä¸ªæ¥æ”¶ç«¯ï¼Œå¤šä¸ªå‘é€ç«¯</p>
<p>æ¯ä¸ª Worker éƒ½éœ€è¦æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œä½†åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ª Worker èƒ½æ”¶åˆ°æ¶ˆæ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ <code>Arc</code> å’Œ <code>Mutex</code> æ¥åˆ†å‘æ¥æ”¶ç«¯</p>
<pre><code class="language-rust">pub fn new(size: usize) -&gt; ThreadPool {
    let mut workers = Vec::with_capacity(size);
    let (sender, reciver) = mpsc::channel();
    let reciver = Arc::new(Mutex::new(reciver));

    for id in 0..size {
        workers.push(Worker::new(id, Arc::clone(&amp;reciver)));
    }

    ThreadPool { workers, sender }
}</code></pre>
<p>æˆ‘ä»¬åœ¨ Worker ä¸­ä¼ é€’çš„æ¶ˆæ¯å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼Œå·¥ä½œå’Œç»ˆæ­¢ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>Message</code> æ¥åŒ…è£¹</p>
<p>Worker ä½¿ç”¨ <code>thread::spawn()</code> æ¥ç”Ÿæˆçº¿ç¨‹ï¼Œéœ€è¦æ‰§è¡Œçš„ä»£ç å°±æ˜¯ä¸æ–­ç­‰å¾…</p>
<p>å¦‚æœæ‹¿åˆ°äº†æ¥æ”¶ç«¯ï¼Œæ”¶åˆ°äº†æ¶ˆæ¯ï¼Œåˆ™æ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœæ”¶åˆ°äº†ç»ˆæ­¢ä¿¡å· <code>Message::Terminate</code>ï¼Œåˆ™ <code>break</code> ç»ˆæ­¢</p>
<pre><code class="language-rust">fn new(id: usize, receiver: Arc&lt;Mutex&lt;mpsc::Receiver&lt;Message&gt;&gt;&gt;) -&gt; Worker {
    let thread = thread::spawn(move || loop {
        let message = receiver.lock().unwrap().recv().unwrap();
        match message {
            Message::NewJob(job) =&gt; {
                println!("Worker {} got a job, executing!", id);
                job.call_box();
            }
            Message::Terminate =&gt; {
                println!("Worker {} was told to terminate", id);
                break;
            }
        }
    });

    Worker {
        id,
        thread: Some(thread),
    }
}</code></pre>
<p>ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†ç»“æŸï¼Œå³éœ€è¦å®ç° <code>Drop</code> è¿™ä¸ªç‰¹æ€§</p>
<pre><code class="language-rust">fn drop(&amp;mut self) {
    for _ in &amp;mut self.workers {
        self.sender.send(Message::Terminate).unwrap();
    }

    for worker in &amp;mut self.workers {
        println!("shuutting down worker {}", worker.id);

        if let Some(thread) = worker.thread.take() {
            thread.join().unwrap();
        }
    }
}</code></pre>
<p>é¦–å…ˆå‘æ¯ä¸ª Worker å‘é€ä¸€ä¸ªç»ˆæ­¢ä¿¡å·ï¼Œç„¶åä½¿ç”¨ <code>worker.thread.take()</code> å°†çº¿ç¨‹å–å‡ºï¼Œä½¿ç”¨ <code>join()</code> æ–¹æ³•ç­‰å¾…çº¿ç¨‹ç»“æŸ</p>
<p>ç„¶åæˆ‘ä»¬çš„ä¸»å‡½æ•°ä¹Ÿè¦ä¿®æ”¹</p>
<pre><code class="language-rust">use std::{
    fs,
    io::{Read, Write},
    net::{TcpListener, TcpStream},
    thread,
    time::Duration,
};

use simple_server::ThreadPool;

fn main() {
    const PORT: usize = 7878;
    let listener = TcpListener::bind(format!("127.0.0.1:{}", PORT)).unwrap();
    let pool = ThreadPool::new(4);

    for stream in listener.incoming().take(2) {
        let stream = stream.unwrap();

        pool.execute(|| {
            handle_connection(stream);
        })
    }

    println!("end!");
}

fn handle_connection(mut stream: TcpStream) {
    let mut buffer = [0; 512];
    stream.read(&amp;mut buffer).unwrap();
    let root = b"GET / HTTP/1.1\r\n";
    let sleep = b"GET /sleep HTTP/1.1\r\n";

    let (status, page_path) = if buffer.starts_with(root) {
        ("HTTP/1.1 200 OK\r\n\r\n", "simple_server/web/index.html")
    } else if buffer.starts_with(sleep) {
        thread::sleep(Duration::from_secs(10));
        ("HTTP/1.1 200 OK\r\n\r\n", "simple_server/web/index.html")
    } else {
        (
            "HTTP/1.1 404 NOT FOUND\r\n\r\n",
            "simple_server/web/404.html",
        )
    };
    stream
        .write(format!("{}{}", status, fs::read_to_string(page_path).unwrap(),).as_bytes())
        .unwrap();
    stream.flush().unwrap();
}</code></pre>
<p>ä½¿ç”¨ <code>let pool = ThreadPool::new(4);</code> ç”Ÿæˆä¸€ä¸ª <code>4</code> çº¿ç¨‹çš„çº¿ç¨‹æ± </p>
<p>è€Œååœ¨å¾ªç¯ä¸­ä½¿ç”¨ <code>pool.execute()</code> æ¥å°†ä»»åŠ¡æ”¾è¿›çº¿ç¨‹æ± </p>
<p>å¥½ï¼Œè‡³æ­¤ï¼Œè¿™ä¸ªååˆ†ç®€é™‹çš„æœåŠ¡å™¨å°±ç®—æ˜¯å®Œæˆäº†</p>
<hr />
<p>åˆ°è¿™é‡Œï¼ŒRust çš„åŸºç¡€å­¦ä¹ å°±ç®—ç»“æŸäº†ï¼Œå¯ä»¥å¥½å¥½å‡†å¤‡è€ƒè¯•äº†</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>ç«¯å£é€‰æ‹©éšæ„ï¼Œè¿™é‡Œåªæ˜¯é€‰äº†ä¸€ä¸ªä¸å¸¸ç”¨çš„ç«¯å£</p>
</div>
</main>
                        <nav class="nav-wrapper" aria-label="Page navigation">
                            <a rel="prev" href="../../notes/rust/20221030-rust-learn-final.html"
                                class="mobile-nav-chapters previous"
                                title="Previous chapter"
                                aria-label="Previous chapter"
                                aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next prefetch"
                                href="../../notes/postgresql/index.html"
                                class="mobile-nav-chapters next"
                                title="Next chapter" aria-label="Next chapter"
                                aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                            <div style="clear: both"></div>
                        </nav>
                    </div>
                </div>
                <div class="giscus-comment">
                </div>
                <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../notes/rust/20221030-rust-learn-final.html"
                        class="nav-chapters previous" title="Previous chapter"
                        aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next prefetch" href="../../notes/postgresql/index.html"
                        class="nav-chapters next" title="Next chapter"
                        aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                </nav>
            </div>
            <script>
                window.playground_copyable = true;
            </script>
            <script src="../../elasticlunr.min.js"></script>
            <script src="../../mark.min.js"></script>
            <script src="../../searcher.js"></script>
            <script src="../../clipboard.min.js"></script>
            <script src="../../highlight.js"></script>
            <script src="../../book.js"></script>
            <script src="../../theme/giscus.js"></script>
        </div>
    </body>
</html>
