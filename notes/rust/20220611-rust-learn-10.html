<!DOCTYPE HTML>
<html
    lang="zh-Hans" 
    class="rust" 
    dir="ltr"> 
    <head>
        <title>Rust 学习 10 - Kevin Stephen&#x27;s Blogs</title> 
        <meta charset="UTF-8">
        <meta name="description" content="找到属于自己的光">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">
        
         
        <link rel="icon" href="../../favicon.svg">
         
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">

        <link rel="stylesheet"
            href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <link rel="stylesheet" href="../../theme/utils.css">

    </head>
    <body class="sidebar-visible no-js">
        <div id="body-container">
            <script>
                // 获取 root 路径
                var path_to_root = "../../";
                // 获取默认主题
                var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches
                    ? "ayu"
                    : "rust";
            </script>
            <script>
                try {
                    var theme = localStorage.getItem("mdbook-theme");
                    var sidebar = localStorage.getItem("mdbook-sidebar");

                    if (theme.startsWith('"') && theme.endsWith('"')) {
                        localStorage.setItem(
                            "mdbook-theme",
                            theme.slice(1, theme.length - 1).trim()
                        );
                    }

                    if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                        localStorage.setItem(
                            "mdbook-sidebar",
                            sidebar.slice(1, sidebar.length - 1).trim()
                        );
                    }
                } catch (e) {}
            </script>
            <script>
                var theme;
                try {
                    theme = localStorage.getItem("mdbook-theme");
                } catch (e) {}
                if (theme === null || theme === undefined) {
                    theme = default_theme;
                }
                var html = document.querySelector("html");
                html.classList.remove("rust");
                html.classList.add(theme);
                var body = document.querySelector("body");
                body.classList.remove("no-js");
                body.classList.add("js");
            </script>

            <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">
            <script>
                var body = document.querySelector("body");
                var sidebar = null;
                var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
                if (document.body.clientWidth >= 1080) {
                try {
                    sidebar = localStorage.getItem("mdbook-sidebar");
                } catch (e) {}
                    sidebar = sidebar || "visible";
                } else {
                    sidebar = "hidden";
                }
                sidebar_toggle.checked = sidebar === "visible";
                body.classList.remove("sidebar-visible");
                body.classList.add("sidebar-" + sidebar);
            </script>

            <nav id="sidebar" class="sidebar" aria-label="Table of contents">
                <div class="sidebar-scrollbox">
                    <ol class="chapter"><li class="chapter-item "><a href="../../init.html">Init</a></li><li class="chapter-item "><a href="../../about.html">About</a></li><li class="chapter-item affix "><li class="part-title">Notes</li><li class="chapter-item expanded "><a href="../../notes/rust/index.html">Rust</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../notes/rust/20210605-rust-learn-01.html">Rust 学习 01</a></li><li class="chapter-item "><a href="../../notes/rust/20210610-rust-learn-02.html">Rust 学习 02</a></li><li class="chapter-item "><a href="../../notes/rust/20210824-rust-learn-03.html">Rust 学习 03</a></li><li class="chapter-item "><a href="../../notes/rust/20211216-rust-learn-04.html">Rust 学习 04</a></li><li class="chapter-item "><a href="../../notes/rust/20220512-rust-learn-05.html">Rust 学习 05</a></li><li class="chapter-item "><a href="../../notes/rust/20220514-rust-learn-06.html">Rust 学习 06</a></li><li class="chapter-item "><a href="../../notes/rust/20220520-rust-learn-07.html">Rust 学习 07</a></li><li class="chapter-item "><a href="../../notes/rust/20220522-rust-learn-08.html">Rust 学习 08</a></li><li class="chapter-item "><a href="../../notes/rust/20220523-rust-learn-09.html">Rust 学习 09</a></li><li class="chapter-item expanded "><a href="../../notes/rust/20220611-rust-learn-10.html" class="active">Rust 学习 10</a></li><li class="chapter-item "><a href="../../notes/rust/20220619-rust-learn-11.html">Rust 学习 11</a></li><li class="chapter-item "><a href="../../notes/rust/20220619-rust-learn-project-01.html">Rust 学习 实例 01</a></li><li class="chapter-item "><a href="../../notes/rust/20220623-rust-learn-12.html">Rust 学习 12</a></li><li class="chapter-item "><a href="../../notes/rust/20220624-rust-learn-13.html">Rust 学习 13</a></li><li class="chapter-item "><a href="../../notes/rust/20220925-rust-learn-14.html">Rust 学习 14</a></li><li class="chapter-item "><a href="../../notes/rust/20220925-rust-learn-15.html">Rust 学习 15</a></li><li class="chapter-item "><a href="../../notes/rust/20221030-rust-learn-final.html">Rust 学习 final</a></li><li class="chapter-item "><a href="../../notes/rust/20221030-rust-learn-project-02.html">Rust 学习 实例 02</a></li></ol></li><li class="chapter-item "><a href="../../notes/postgresql/index.html">PostgreSQL</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../notes/postgresql/20230502-psql-learn-01.html">PostgreSQL 学习 01</a></li><li class="chapter-item "><a href="../../notes/postgresql/20231024-psql-learn-02.html">PostgreSQL 学习 02</a></li><li class="chapter-item "><a href="../../notes/postgresql/20231110-psql-learn-03.html">PostgreSQL 学习 03</a></li></ol></li><li class="chapter-item "><a href="../../notes/typechallenges/index.html">Type Challenges</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../notes/typechallenges/20230425-type-challenges-01.html">TypeScript 类型体操 01</a></li><li class="chapter-item "><a href="../../notes/typechallenges/20230428-type-challenges-02.html">TypeScript 类型体操 02</a></li></ol></li><li class="chapter-item "><li class="part-title">Miscellany</li><li class="chapter-item "><a href="../../miscellany/coding/index.html">Coding</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../miscellany/coding/20210604-scope-of-if-statement.html">if 语句的作用域</a></li><li class="chapter-item "><a href="../../miscellany/coding/20221026-parse-math-in-c.html">C 语言数学解析器</a></li><li class="chapter-item "><a href="../../miscellany/coding/20231107-clash-system-agent.html">C𝜆ash 系统代理</a></li><li class="chapter-item "><a href="../../miscellany/coding/20240228-use-giscus-in-mdbook.html">在 mdBook 中使用 giscus 服务</a></li></ol></li><li class="chapter-item "><a href="../../miscellany/study/index.html">Study</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../miscellany/study/20221108-qiskit-linear-algebra.html">qiskit 线性代数</a></li><li class="chapter-item "><a href="../../miscellany/study/20221111-qiskit-Deutsch-Jozsa-algorithm.html">qiskit Deutsch-Jozsa 算法</a></li></ol></li><li class="chapter-item "><a href="../../miscellany/life/index.html">Life</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../miscellany/life/20230411-about-life.html">说说以后的打算罢</a></li><li class="chapter-item "><a href="../../miscellany/life/20230715-about-job.html">谈谈最近的工作状态</a></li><li class="chapter-item "><a href="../../miscellany/life/20230915-end-of-summer.html">暑假结束了</a></li><li class="chapter-item "><a href="../../miscellany/life/20231020-new-life.html">新的生活</a></li><li class="chapter-item "><a href="../../miscellany/life/20240120-busy-life.html">忙忙碌碌</a></li></ol></li></ol>
                </div>
                <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                    <div class="sidebar-resize-indicator"></div>
                </div>
            </nav>

            <script>
                var sidebarScrollbox = document.querySelector("#sidebar .sidebar-scrollbox");
                sidebarScrollbox.addEventListener(
                    "click",
                    function (e) {
                        if (e.target.tagName === "A") {
                            sessionStorage.setItem("sidebar-scroll", sidebarScrollbox.scrollTop);
                        }
                    },
                    { passive: true }
                );
                var sidebarScrollTop = sessionStorage.getItem("sidebar-scroll");
                sessionStorage.removeItem("sidebar-scroll");
                if (sidebarScrollTop) {
                    // preserve sidebar scroll position when navigating via links within sidebar
                    sidebarScrollbox.scrollTop = sidebarScrollTop;
                } else {
                    // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                    var activeSection = document.querySelector("#sidebar .active");
                    if (activeSection) {
                        activeSection.scrollIntoView({ block: "center" });
                    }
                }
            </script>

            <div id="page-wrapper" class="page-wrapper">
                <div class="page">
                                        <div id="menu-bar-hover-placeholder"></div>
                    <div id="menu-bar" class="menu-bar sticky">
                        <div class="left-buttons">
                            <label id="sidebar-toggle" class="icon-button"
                                for="sidebar-toggle-anchor"
                                title="Toggle Table of Contents"
                                aria-label="Toggle Table of Contents"
                                aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </label>
                            <button id="theme-toggle" class="icon-button"
                                type="button" title="Change theme"
                                aria-label="Change theme" aria-haspopup="true"
                                aria-expanded="false"
                                aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup"
                                aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem"
                                        class="theme"
                                        id="light">Light</button></li>
                                <li role="none"><button role="menuitem"
                                        class="theme"
                                        id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem"
                                        class="theme"
                                        id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem"
                                        class="theme"
                                        id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem"
                                        class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            <button id="search-toggle" class="icon-button"
                                type="button" title="Search. (Shortkey: s)"
                                aria-label="Toggle Searchbar"
                                aria-expanded="false" aria-keyshortcuts="S"
                                aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                        </div>
                        <h1 class="menu-title">Kevin Stephen&#x27;s Blogs</h1>
                        <div class="right-buttons">
                            <a href="https://github.com/kands-code/kands-code.github.io"
                                title="Git repository"
                                aria-label="Git repository">
                                <i id="git-repository-button"
                                    class="fa fa-github"></i>
                            </a>
                            <a href="https://github.com/kands-code/kands-code.github.io/edit/repo-src/src/src/notes/rust/20220611-rust-learn-10.md"
                                title="Suggest an edit"
                                aria-label="Suggest an edit">
                                <i id="git-edit-button" class="fa fa-edit"></i>
                            </a>
                        </div>
                    </div>
                    <div id="search-wrapper" class="hidden">
                        <form id="searchbar-outer" class="searchbar-outer">
                            <input type="search" id="searchbar" name="searchbar"
                                placeholder="searching..."
                                aria-controls="searchresults-outer"
                                aria-describedby="searchresults-header">
                        </form>
                        <div id="searchresults-outer"
                            class="searchresults-outer hidden">
                            <div id="searchresults-header"
                                class="searchresults-header"></div>
                            <ul id="searchresults">
                            </ul>
                        </div>
                    </div>
                    <script>
                        document
                            .getElementById("sidebar-toggle")
                            .setAttribute("aria-expanded", sidebar === "visible");
                        document
                            .getElementById("sidebar")
                            .setAttribute("aria-hidden", sidebar !== "visible");
                        Array.from(document.querySelectorAll("#sidebar a")).forEach(function (link) {
                            link.setAttribute("tabIndex", sidebar === "visible" ? 0 : -1);
                        });
                    </script>

                    <div id="content" class="content">
                        <main><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="rust-学习-10"><a class="header" href="#rust-学习-10">Rust 学习 10</a></h1>
<p class="archive-time">archive time: 2022-06-11</p>
<p class="sp-comment">这回来学一下生命周期</p>
<ul>
<li><a href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">生命周期</a>
<ul>
<li><a href="#example">example</a></li>
<li><a href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%A0%87%E6%B3%A8">生命周期标注</a></li>
<li><a href="#%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">结构体的生命周期</a></li>
<li><a href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E8%A7%84%E5%88%99">生命周期规则</a></li>
<li><a href="#%E9%9D%99%E6%80%81%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">静态生命周期</a></li>
</ul>
</li>
<li><a href="#%E6%B5%8B%E8%AF%95">测试</a>
<ul>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF%E6%B6%88%E6%81%AF">自定义错误消息</a></li>
<li><a href="#should_panic">should_panic</a></li>
<li><a href="#%E6%B5%8B%E8%AF%95%E9%87%8C%E7%9A%84-result">测试里的 <code>Result</code></a></li>
<li><a href="#cargo-test"><code>cargo test</code></a>
<ul>
<li><a href="#%E6%B5%8B%E8%AF%95%E7%BA%BF%E7%A8%8B%E6%95%B0">测试线程数</a></li>
<li><a href="#%E6%98%BE%E7%A4%BA%E8%BE%93%E5%87%BA">显示输出</a></li>
<li><a href="#%E6%89%A7%E8%A1%8C%E6%8C%87%E5%AE%9A%E6%B5%8B%E8%AF%95">执行指定测试</a></li>
<li><a href="#%E5%BF%BD%E7%95%A5%E6%B5%8B%E8%AF%95">忽略测试</a></li>
</ul>
</li>
<li><a href="#%E6%B5%8B%E8%AF%95%E7%BB%84%E7%BB%87">测试组织</a>
<ul>
<li><a href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95">单元测试</a></li>
<li><a href="#%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95">集成测试</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="生命周期"><a class="header" href="#生命周期">生命周期</a></h2>
<p>Rust 中, 每个 <strong><em>引用</em></strong> 都有自己的生命周期, 是为了让引用保持有效的作用域</p>
<p>大多数情况下, 生命周期是可以被自动推导的, 不需要手动标注</p>
<p>但是有些情况下还是需要自己手动标注的, 例如 <code>'static</code></p>
<pre><code class="language-rust">pub fn derv&lt;'a, F&gt;(f: &amp;'a F) -&gt; Box&lt;dyn Fn(f64) -&gt; f64 + 'a&gt;
where
    F: Fn(f64) -&gt; f64 + 'a,
{
    let dx = 1e-6;
    Box::new(move |x: f64| -&gt; f64 { (f(x + dx) - f(x)) / dx })
}</code></pre>
<p>在上面这个函数的例子里, 我们需要手动给泛型 Trait <code>F</code> 加上 <code>'a</code> 这样一个生命周期的约束</p>
<p>加上生命周期的约束是为了指明返回值和参数之间的关系</p>
<p>生命周期要解决的问题就是在 <code>Cpp</code> 中常见的错误 <strong>悬垂引用 (<em>dangling reference</em>)</strong></p>
<pre><code class="language-rust">let r;
{
    let x = 6;
    r = &amp;x; // error here
}
println("{}", r);</code></pre>
<p>上面这个例子, 由于 <code>x</code> 在离开作用域后就被 <em>drop</em> 掉了, 所以 <code>r</code> 就借用了一个无效的值,
这是错误的, 而 Rust 编译器可以检查出这种问题</p>
<p>Rust 编译器 使用了 <em>Borrow Checker</em> 通过比较作用域来判断所有的借用是否合法</p>
<h3 id="example"><a class="header" href="#example">example</a></h3>
<p>这里看一个函数的例子</p>
<pre><code class="language-rust">fn longest(x: &amp;str, y: &amp;str) -&gt; &amp;str {
    if x.len() &gt; y.len() {
        x
    } else {
        y
    }
}</code></pre>
<p>这里由于 <code>x</code> 和 <code>y</code> 这两个引用的生命周期有可能有区别, 所以需要显式标注生命周期</p>
<p>解决方法就是标注上生命周期</p>
<pre><code class="language-rust">fn longest&lt;'a&gt;(x: &amp;'a str, y: &amp;'a str) -&gt; &amp;'a str {
    if x.len() &gt; y.len() {
        x
    } else {
        y
    }
}</code></pre>
<h3 id="生命周期标注"><a class="header" href="#生命周期标注">生命周期标注</a></h3>
<p>生命周期以 <code>'</code> 开头, 而且是全小写, 标识符一般比较短, 常见命名就是 <code>'a</code></p>
<p>生命周期一般放在引用符号之后</p>
<pre><code class="language-rust">&amp;i32 // ref
&amp;'a i32 // explict lifetime ref
&amp;'a mut i32 // mutable explict lifetime ref</code></pre>
<p>不过单个生命周期标注没有意义, 标注一般用于说明多个引用之间的生命周期的 <em>关系</em></p>
<pre><code class="language-rust">fn longest&lt;'a&gt;(x: &amp;'a str, y: &amp;'a str) -&gt; &amp;'a str</code></pre>
<p>这里表明 返回值 和 <code>x</code> 以及 <code>y</code> 的生命周期不短于 <code>'a</code>, 即保证了返回的引用的有效性</p>
<p>从函数返回引用时, <em>返回值</em> 的生命周期参数需要和其中一个参数的生命周期 <strong>匹配</strong></p>
<h3 id="结构体的生命周期"><a class="header" href="#结构体的生命周期">结构体的生命周期</a></h3>
<p>在 <code>struct</code> 里有 引用数据项 的时候, 需要在每个引用上添加生命周期标注</p>
<pre><code class="language-rust">struct Test&lt;'a&gt; {
    part: &amp;'a str,
}</code></pre>
<p>这里是为了保证在结构体实例有效的时候, 内部的引用也是有效的</p>
<h3 id="生命周期规则"><a class="header" href="#生命周期规则">生命周期规则</a></h3>
<p>编译器有 3 条<sup class="footnote-reference"><a href="#1">1</a></sup>规则用于推导引用的生命周期</p>
<ol>
<li>每个引用类型的参数都有自己的生命周期</li>
<li>如果只有一个生命周期参数, 那么该生命周期就被赋给所有的输出生命周期参数</li>
<li>如果有多个输入生命周期参数, 但其中一个是 <code>&amp;self</code> 或者 <code>&amp;mut self</code>,
那么 <code>self</code> 的生命周期会被赋给所有的输出生命周期参数</li>
</ol>
<pre><code class="language-rust">/// ex01
fn first_word(s: &amp;str) -&gt; &amp;str
// =&gt; rule 1
fn first_word&lt;'a&gt;(s: &amp;'a str) -&gt; &amp;str
// =&gt; rule 2
fn first_word&lt;'a&gt;(s: &amp;'a str) -&gt; &amp;'a str

/// ex02
fn longest(x: &amp;str, y: &amp;str) -&gt; &amp;str
// =&gt; rule 1
fn longest&lt;'a, 'b&gt;(x: &amp;'a str, y: &amp;'b str) -&gt; &amp;str
// 不能继续推导 报错</code></pre>
<h3 id="静态生命周期"><a class="header" href="#静态生命周期">静态生命周期</a></h3>
<p><code>'static</code> 是比较特殊的生命周期, 表明在整个程序持续时间内都是有效的</p>
<p>所有的字符串字面值的生命周期都是 <code>'static</code></p>
<p>一般没必要使用 <code>'static</code> 生命周期</p>
<h2 id="测试"><a class="header" href="#测试">测试</a></h2>
<p>在写程序的时候, 为了验证程序的正确性, 往往需要进行一些测试</p>
<blockquote>
<p>arrange, act, assert</p>
</blockquote>
<p>用于测试的函数需要使用 <code>#[test]</code> 这样一个 <em>attribute</em> 来标注</p>
<blockquote>
<p>attribute 就是一段 Rust 代码的元数据</p>
</blockquote>
<p>如果写了一些测试函数要运行测试, 可以使用 <code>cargo test</code> 命令来执行测试</p>
<pre><code class="language-rust">#[cfg(test)]
pub mod tests {
    use crate::utils::numeric as N;
    #[test]
    fn do_test() {
        let tol = 1e-6;
        let cbrt = |x: f64| -&gt; f64 { N::newton(&amp;move |y: f64| -&gt; f64 { x - y * y * y }, 1.0) };
        assert!((cbrt(8.0) - 2.0).abs() &lt; tol);
    }
}</code></pre>
<p>上面是一个比较经典的测试例子</p>
<h3 id="自定义错误消息"><a class="header" href="#自定义错误消息">自定义错误消息</a></h3>
<p><code>assert!()</code> 等宏是可以添加自定义信息的, 在测试失败的时候打印出来</p>
<pre><code class="language-rust">#[test]
fn another() {
    assert!(2 &gt; 4, "\nhello {}\n", "ok");
}

/// ...

/*
---- tests::tests::another stdout ----
thread 'tests::tests::another' panicked at '
hello ok
', src\tests.rs:13:9
*/</code></pre>
<p>上面就是一个自定义错误信息的例子, 我们测试失败了, 输出了 <code>hello ok</code></p>
<h3 id="should_panic"><a class="header" href="#should_panic">should_panic</a></h3>
<p>这里要介绍一个新的 特性(attribute), <code>#[should_panic]</code></p>
<pre><code class="language-rust">pub struct Guess {
    val: u32
}

impl Guess {
    pub fn new(val: u32) -&gt; Self {
        if val &lt; 1 || val &gt; 100 {
            panic!("Guess value must between 1 and 100, got '{}'", val);
        }
        Guess { val }
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    #[should_panic]
    fn greater_than_100() {
        Guess::new(200);
    }
}</code></pre>
<p>即, 对于会发生 恐慌(panic) 的函数或代码片段进行标注</p>
<p>如果真的发生了恐慌, 则测试成功</p>
<p>对于更加精确的测试, 可以使用 <code>expected</code> 参数来指明 <code>panic!()</code> 的报错包含的内容</p>
<pre><code class="language-rust">/// ...
#[should_panic(expected = "anyway")]
/// ...</code></pre>
<p>如果 panic 中不包含指定内容, 那么就算测试失败</p>
<h3 id="测试里的-result"><a class="header" href="#测试里的-result">测试里的 <code>Result</code></a></h3>
<p>之前有说过, Rust 里的一种更加常用的错误处理方式就是使用 <code>Result&lt;T, E&gt;</code></p>
<p>相较于使用 <code>assert!()</code> 即 <code>panic!()</code>, 还可直接返回 Result 类型来进行测试</p>
<pre><code class="language-rust">#[test]
fn it_works() -&gt; Result&lt;(), String&gt; {
    if 2 + 2 == 4 {
        Ok(())
    } else {
        Err(String::from("2 + 2 != 4"))
    }
}</code></pre>
<h3 id="cargo-test"><a class="header" href="#cargo-test"><code>cargo test</code></a></h3>
<p>对于 <code>cargo test</code> 这个命令, 我们还可以使用参数来控制具体测试行为</p>
<h4 id="测试线程数"><a class="header" href="#测试线程数">测试线程数</a></h4>
<p>如果要并行测试, 那么需要保证测试之间不会相互依赖</p>
<pre><code class="language-bash">cargo test -- --test-threads=12
</code></pre>
<p>如果不想并行测试, 可以指定线程数为 <code>1</code>, 即单线程测试即可</p>
<h4 id="显示输出"><a class="header" href="#显示输出">显示输出</a></h4>
<p>默认情况下, 通过的测试不会输出相关测试的输出内容</p>
<p>如果想要输出所有的输出内容, 可以使用 <code>--show-output</code> 选项</p>
<pre><code class="language-bash">cargo test -- --show-output
</code></pre>
<h4 id="执行指定测试"><a class="header" href="#执行指定测试">执行指定测试</a></h4>
<p>有时候执行所有的测试是比较费时的, 而大多数情况是不需要进行所有测试的, 所以需要指定测试名称</p>
<pre><code class="language-bash">cargo test &lt;测试函数名&gt;
</code></pre>
<p>但是这样只能测试一个函数, 即只能传递一个函数名</p>
<p>我们还可以使用</p>
<pre><code class="language-bash">cargo test &lt;测试名称&gt;
</code></pre>
<p>来指定测试范围, 只要测试函数的名称中(包括模块名) 含有指定的测试名称, 那么就会被执行</p>
<h4 id="忽略测试"><a class="header" href="#忽略测试">忽略测试</a></h4>
<p>对于一些比较麻烦的测试, 我们可以使用 <code>#[ignore]</code> 这个特性来忽略</p>
<p>如果要单独测试被忽略的测试, 可以使用 <code>--ignored</code> 参数</p>
<pre><code class="language-bash">cargo test -- --ignored
</code></pre>
<h3 id="测试组织"><a class="header" href="#测试组织">测试组织</a></h3>
<p>一般测试可以分为 单元测试 和 集成测试</p>
<p>单元测试 可以测试所有内容, 而 集成测试 一般只能测试 公开(pub) 内容</p>
<h4 id="单元测试"><a class="header" href="#单元测试">单元测试</a></h4>
<p>单元测试一般使用 <code>#[cfg(test)]</code> 来标注</p>
<ul>
<li>只有运行 <code>cargo test</code> 才会编译和运行</li>
<li><code>cargo build</code> 不会编译</li>
</ul>
<h4 id="集成测试"><a class="header" href="#集成测试">集成测试</a></h4>
<p>集成测试完全位于被测试的内容之外</p>
<p>集成测试一般用于测试库的多个部分是否能正常地工作</p>
<p>集成测试一般位于 <code>&lt;projRoot&gt;/tests</code> 目录下, 与 <code>src</code> 目录平级</p>
<pre><code class="language-plain">C:.
|   .gitignore
|   Cargo.lock
|   Cargo.toml
|
+---src
|   |   lib.rs
|   |   main.rs
|   |
|   \---utils
|           mod.rs
|           numeric.rs
|
\---tests
        int_tests.rs
</code></pre>
<p>如果要测试单独地某个集成测试的文件, 可以使用</p>
<pre><code class="language-bash">cargo test --test &lt;文件名&gt;
</code></pre>
<p>对于集成测试子模块, 如一些帮助函数, 可以使用文件夹分隔</p>
<p>即，<code>tests/</code> 下的子目录不会被视为单独的 crate 来编译, 不会被测试</p>
<p>但是注意, 集成测试只针对于 <strong>库类型</strong> 的包, 对于二进制包, 由于无法对外暴露函数, 故无法使用集成测试, 只能使用 <strong>单元测试</strong></p>
<p>所以一般都是二进制包和库包混合的形式, 方便进行测试</p>
<hr />
<p>好, 今天就学到这里罢</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>到目前为止, 未来会添加更多</p>
</div>
</main>
                        <nav class="nav-wrapper" aria-label="Page navigation">
                            <a rel="prev" href="../../notes/rust/20220523-rust-learn-09.html"
                                class="mobile-nav-chapters previous"
                                title="Previous chapter"
                                aria-label="Previous chapter"
                                aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next prefetch"
                                href="../../notes/rust/20220619-rust-learn-11.html"
                                class="mobile-nav-chapters next"
                                title="Next chapter" aria-label="Next chapter"
                                aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                            <div style="clear: both"></div>
                        </nav>
                    </div>
                </div>
                <div class="giscus-comment">
                </div>
                <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../notes/rust/20220523-rust-learn-09.html"
                        class="nav-chapters previous" title="Previous chapter"
                        aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next prefetch" href="../../notes/rust/20220619-rust-learn-11.html"
                        class="nav-chapters next" title="Next chapter"
                        aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                </nav>
            </div>
            <script>
                window.playground_copyable = true;
            </script>
            <script src="../../elasticlunr.min.js"></script>
            <script src="../../mark.min.js"></script>
            <script src="../../searcher.js"></script>
            <script src="../../clipboard.min.js"></script>
            <script src="../../highlight.js"></script>
            <script src="../../book.js"></script>
            <script src="../../theme/giscus.js"></script>
        </div>
    </body>
</html>
