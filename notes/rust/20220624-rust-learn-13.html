<!DOCTYPE HTML>
<html
    lang="zh-Hans" 
    class="rust" 
    dir="ltr"> 
    <head>
        <title>Rust å­¦ä¹  13 - Kevin Stephen&#x27;s Blogs</title> 
        <meta charset="UTF-8">
        <meta name="description" content="æ‰¾åˆ°å±äºè‡ªå·±çš„å…‰">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">
        
         
        <link rel="icon" href="../../favicon.svg">
         
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">

        <link rel="stylesheet"
            href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <link rel="stylesheet" href="../../theme/utils.css">

    </head>
    <body class="sidebar-visible no-js">
        <div id="body-container">
            <script>
                // è·å– root è·¯å¾„
                var path_to_root = "../../";
                // è·å–é»˜è®¤ä¸»é¢˜
                var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches
                    ? "ayu"
                    : "rust";
            </script>
            <script>
                try {
                    var theme = localStorage.getItem("mdbook-theme");
                    var sidebar = localStorage.getItem("mdbook-sidebar");

                    if (theme.startsWith('"') && theme.endsWith('"')) {
                        localStorage.setItem(
                            "mdbook-theme",
                            theme.slice(1, theme.length - 1).trim()
                        );
                    }

                    if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                        localStorage.setItem(
                            "mdbook-sidebar",
                            sidebar.slice(1, sidebar.length - 1).trim()
                        );
                    }
                } catch (e) {}
            </script>
            <script>
                var theme;
                try {
                    theme = localStorage.getItem("mdbook-theme");
                } catch (e) {}
                if (theme === null || theme === undefined) {
                    theme = default_theme;
                }
                var html = document.querySelector("html");
                html.classList.remove("rust");
                html.classList.add(theme);
                var body = document.querySelector("body");
                body.classList.remove("no-js");
                body.classList.add("js");
            </script>

            <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">
            <script>
                var body = document.querySelector("body");
                var sidebar = null;
                var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
                if (document.body.clientWidth >= 1080) {
                try {
                    sidebar = localStorage.getItem("mdbook-sidebar");
                } catch (e) {}
                    sidebar = sidebar || "visible";
                } else {
                    sidebar = "hidden";
                }
                sidebar_toggle.checked = sidebar === "visible";
                body.classList.remove("sidebar-visible");
                body.classList.add("sidebar-" + sidebar);
            </script>

            <nav id="sidebar" class="sidebar" aria-label="Table of contents">
                <div class="sidebar-scrollbox">
                    <ol class="chapter"><li class="chapter-item "><a href="../../init.html">Init</a></li><li class="chapter-item affix "><li class="part-title">Notes</li><li class="chapter-item expanded "><a href="../../notes/rust/index.html">Rust</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../notes/rust/20210605-rust-learn-01.html">Rust å­¦ä¹  01</a></li><li class="chapter-item "><a href="../../notes/rust/20210610-rust-learn-02.html">Rust å­¦ä¹  02</a></li><li class="chapter-item "><a href="../../notes/rust/20210824-rust-learn-03.html">Rust å­¦ä¹  03</a></li><li class="chapter-item "><a href="../../notes/rust/20211216-rust-learn-04.html">Rust å­¦ä¹  04</a></li><li class="chapter-item "><a href="../../notes/rust/20220512-rust-learn-05.html">Rust å­¦ä¹  05</a></li><li class="chapter-item "><a href="../../notes/rust/20220514-rust-learn-06.html">Rust å­¦ä¹  06</a></li><li class="chapter-item "><a href="../../notes/rust/20220520-rust-learn-07.html">Rust å­¦ä¹  07</a></li><li class="chapter-item "><a href="../../notes/rust/20220522-rust-learn-08.html">Rust å­¦ä¹  08</a></li><li class="chapter-item "><a href="../../notes/rust/20220523-rust-learn-09.html">Rust å­¦ä¹  09</a></li><li class="chapter-item "><a href="../../notes/rust/20220611-rust-learn-10.html">Rust å­¦ä¹  10</a></li><li class="chapter-item "><a href="../../notes/rust/20220619-rust-learn-11.html">Rust å­¦ä¹  11</a></li><li class="chapter-item "><a href="../../notes/rust/20220619-rust-learn-project-01.html">Rust å­¦ä¹  å®ä¾‹ 01</a></li><li class="chapter-item "><a href="../../notes/rust/20220623-rust-learn-12.html">Rust å­¦ä¹  12</a></li><li class="chapter-item expanded "><a href="../../notes/rust/20220624-rust-learn-13.html" class="active">Rust å­¦ä¹  13</a></li><li class="chapter-item "><a href="../../notes/rust/20220925-rust-learn-14.html">Rust å­¦ä¹  14</a></li><li class="chapter-item "><a href="../../notes/rust/20220925-rust-learn-15.html">Rust å­¦ä¹  15</a></li><li class="chapter-item "><a href="../../notes/rust/20221030-rust-learn-final.html">Rust å­¦ä¹  final</a></li><li class="chapter-item "><a href="../../notes/rust/20221030-rust-learn-project-02.html">Rust å­¦ä¹  å®ä¾‹ 02</a></li></ol></li><li class="chapter-item "><a href="../../notes/postgresql/index.html">PostgreSQL</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../notes/postgresql/20230502-psql-learn-01.html">PostgreSQL å­¦ä¹  01</a></li><li class="chapter-item "><a href="../../notes/postgresql/20231024-psql-learn-02.html">PostgreSQL å­¦ä¹  02</a></li><li class="chapter-item "><a href="../../notes/postgresql/20231110-psql-learn-03.html">PostgreSQL å­¦ä¹  03</a></li></ol></li><li class="chapter-item "><a href="../../notes/typechallenges/index.html">Type Challenges</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../notes/typechallenges/20230425-type-challenges-01.html">TypeScript ç±»å‹ä½“æ“ 01</a></li><li class="chapter-item "><a href="../../notes/typechallenges/20230428-type-challenges-02.html">TypeScript ç±»å‹ä½“æ“ 02</a></li></ol></li><li class="chapter-item "><li class="part-title">Miscellany</li><li class="chapter-item "><a href="../../miscellany/coding/index.html">Coding</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../miscellany/coding/20210604-scope-of-if-statement.html">if è¯­å¥çš„ä½œç”¨åŸŸ</a></li><li class="chapter-item "><a href="../../miscellany/coding/20221026-parse-math-in-c.html">C è¯­è¨€æ•°å­¦è§£æå™¨</a></li><li class="chapter-item "><a href="../../miscellany/coding/20231107-clash-system-agent.html">Cğœ†ash ç³»ç»Ÿä»£ç†</a></li><li class="chapter-item "><a href="../../miscellany/coding/20240228-use-giscus-in-mdbook.html">åœ¨ mdBook ä¸­ä½¿ç”¨ giscus æœåŠ¡</a></li></ol></li><li class="chapter-item "><a href="../../miscellany/study/index.html">Study</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../miscellany/study/20221108-qiskit-linear-algebra.html">qiskit çº¿æ€§ä»£æ•°</a></li><li class="chapter-item "><a href="../../miscellany/study/20221111-qiskit-Deutsch-Jozsa-algorithm.html">qiskit Deutsch-Jozsa ç®—æ³•</a></li></ol></li><li class="chapter-item "><a href="../../miscellany/life/index.html">Life</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../miscellany/life/20230411-about-life.html">è¯´è¯´ä»¥åçš„æ‰“ç®—ç½¢</a></li><li class="chapter-item "><a href="../../miscellany/life/20230715-about-job.html">è°ˆè°ˆæœ€è¿‘çš„å·¥ä½œçŠ¶æ€</a></li><li class="chapter-item "><a href="../../miscellany/life/20230915-end-of-summer.html">æš‘å‡ç»“æŸäº†</a></li><li class="chapter-item "><a href="../../miscellany/life/20231020-new-life.html">æ–°çš„ç”Ÿæ´»</a></li><li class="chapter-item "><a href="../../miscellany/life/20240120-busy-life.html">å¿™å¿™ç¢Œç¢Œ</a></li><li class="spacer"></li></ol></li><li class="chapter-item "><a href="../../about.html">About</a></li></ol>
                </div>
                <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                    <div class="sidebar-resize-indicator"></div>
                </div>
            </nav>

            <script>
                var sidebarScrollbox = document.querySelector("#sidebar .sidebar-scrollbox");
                sidebarScrollbox.addEventListener(
                    "click",
                    function (e) {
                        if (e.target.tagName === "A") {
                            sessionStorage.setItem("sidebar-scroll", sidebarScrollbox.scrollTop);
                        }
                    },
                    { passive: true }
                );
                var sidebarScrollTop = sessionStorage.getItem("sidebar-scroll");
                sessionStorage.removeItem("sidebar-scroll");
                if (sidebarScrollTop) {
                    // preserve sidebar scroll position when navigating via links within sidebar
                    sidebarScrollbox.scrollTop = sidebarScrollTop;
                } else {
                    // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                    var activeSection = document.querySelector("#sidebar .active");
                    if (activeSection) {
                        activeSection.scrollIntoView({ block: "center" });
                    }
                }
            </script>

            <div id="page-wrapper" class="page-wrapper">
                <div class="page">
                                        <div id="menu-bar-hover-placeholder"></div>
                    <div id="menu-bar" class="menu-bar sticky">
                        <div class="left-buttons">
                            <label id="sidebar-toggle" class="icon-button"
                                for="sidebar-toggle-anchor"
                                title="Toggle Table of Contents"
                                aria-label="Toggle Table of Contents"
                                aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </label>
                            <button id="theme-toggle" class="icon-button"
                                type="button" title="Change theme"
                                aria-label="Change theme" aria-haspopup="true"
                                aria-expanded="false"
                                aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup"
                                aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem"
                                        class="theme"
                                        id="light">Light</button></li>
                                <li role="none"><button role="menuitem"
                                        class="theme"
                                        id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem"
                                        class="theme"
                                        id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem"
                                        class="theme"
                                        id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem"
                                        class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            <button id="search-toggle" class="icon-button"
                                type="button" title="Search. (Shortkey: s)"
                                aria-label="Toggle Searchbar"
                                aria-expanded="false" aria-keyshortcuts="S"
                                aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                        </div>
                        <h1 class="menu-title">Kevin Stephen&#x27;s Blogs</h1>
                        <div class="right-buttons">
                            <a href="https://github.com/kands-code/kands-code.github.io"
                                title="Git repository"
                                aria-label="Git repository">
                                <i id="git-repository-button"
                                    class="fa fa-github"></i>
                            </a>
                            <a href="https://github.com/kands-code/kands-code.github.io/edit/repo-src/src/src/notes/rust/20220624-rust-learn-13.md"
                                title="Suggest an edit"
                                aria-label="Suggest an edit">
                                <i id="git-edit-button" class="fa fa-edit"></i>
                            </a>
                        </div>
                    </div>
                    <div id="search-wrapper" class="hidden">
                        <form id="searchbar-outer" class="searchbar-outer">
                            <input type="search" id="searchbar" name="searchbar"
                                placeholder="searching..."
                                aria-controls="searchresults-outer"
                                aria-describedby="searchresults-header">
                        </form>
                        <div id="searchresults-outer"
                            class="searchresults-outer hidden">
                            <div id="searchresults-header"
                                class="searchresults-header"></div>
                            <ul id="searchresults">
                            </ul>
                        </div>
                    </div>
                    <script>
                        document
                            .getElementById("sidebar-toggle")
                            .setAttribute("aria-expanded", sidebar === "visible");
                        document
                            .getElementById("sidebar")
                            .setAttribute("aria-hidden", sidebar !== "visible");
                        Array.from(document.querySelectorAll("#sidebar a")).forEach(function (link) {
                            link.setAttribute("tabIndex", sidebar === "visible" ? 0 : -1);
                        });
                    </script>

                    <div id="content" class="content">
                        <main><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="rust-å­¦ä¹ -13"><a class="header" href="#rust-å­¦ä¹ -13">Rust å­¦ä¹  13</a></h1>
<p class="archive-time">archive time: 2022-06-24</p>
<p class="sp-comment">ä»Šå¤©æ¥çœ‹çœ‹æ™ºèƒ½æŒ‡é’ˆ</p>
<ul>
<li><a href="#%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88">æ™ºèƒ½æŒ‡é’ˆ</a>
<ul>
<li><a href="#%E5%AE%9E%E7%8E%B0%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88">å®ç°æ™ºèƒ½æŒ‡é’ˆ</a></li>
<li><a href="#boxt"><code>Box&lt;T&gt;</code></a></li>
<li><a href="#deref-trait"><code>Deref</code> trait</a>
<ul>
<li><a href="#deref-coercion">Deref Coercion</a></li>
</ul>
</li>
<li><a href="#drop-trait"><code>Drop</code> trait</a></li>
<li><a href="#rct"><code>Rc&lt;T&gt;</code></a></li>
<li><a href="#refcell">RefCell</a></li>
<li><a href="#%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8%E5%92%8C%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F">å¾ªç¯å¼•ç”¨å’Œå†…å­˜æ³„æ¼</a>
<ul>
<li><a href="#weakt"><code>Weak&lt;T&gt;</code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>æŒ‡é’ˆå°±æ˜¯å­˜æ”¾åœ°å€çš„ä¸€ä¸ªå˜é‡, è€Œ Rust é‡Œæœ€å¸¸ç”¨çš„æŒ‡é’ˆå°±æ˜¯ <strong>å¼•ç”¨(ref)</strong></p>
<h2 id="æ™ºèƒ½æŒ‡é’ˆ"><a class="header" href="#æ™ºèƒ½æŒ‡é’ˆ">æ™ºèƒ½æŒ‡é’ˆ</a></h2>
<p>æ™ºèƒ½æŒ‡é’ˆè¡Œä¸ºå’ŒæŒ‡é’ˆç±»ä¼¼, é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€äº›é¢å¤–å…ƒæ•°æ®å’ŒåŠŸèƒ½</p>
<p>å¼•ç”¨è®¡æ•°æ™ºèƒ½æŒ‡é’ˆç±»å‹å¯ä»¥é€šè¿‡è®°å½•æ‰€æœ‰è€…æ•°é‡, ä½¿ä¸€ä»½æ•°æ®èƒ½å¤Ÿè¢«å¤šä¸ªæ‰€æœ‰è€… <strong>åŒæ—¶</strong> æŒæœ‰</p>
<p>å¦‚æœæ²¡æœ‰æ‰€æœ‰è€…, é‚£ä¹ˆæ•°æ®å°†ä¼šè‡ªåŠ¨æ¸…é›¶</p>
<p>ç›¸è¾ƒäºå¼•ç”¨åªæ˜¯ å€Ÿç”¨(borrow) æ•°æ®, æ™ºèƒ½æŒ‡é’ˆå¤šæ•°éƒ½ <em>æ‹¥æœ‰</em> æ‰€æŒ‡å‘çš„æ•°æ®</p>
<p><code>String</code> å’Œ <code>Vec&lt;T&gt;</code> æ˜¯å…¸å‹çš„æ™ºèƒ½æŒ‡é’ˆ</p>
<p>ä¸ä»…æœ‰ä¸€ç‰‡å†…å­˜å¯ä»¥è®©ç”¨æˆ·æ“ä½œ, è¿˜æ‹¥æœ‰å…ƒæ•°æ®, å¦‚å®¹é‡, å’Œä¿éšœ, å¦‚ <code>String</code> ä¿è¯æ˜¯åˆæ³•çš„ <strong>UTF-8</strong> ç¼–ç </p>
<h3 id="å®ç°æ™ºèƒ½æŒ‡é’ˆ"><a class="header" href="#å®ç°æ™ºèƒ½æŒ‡é’ˆ">å®ç°æ™ºèƒ½æŒ‡é’ˆ</a></h3>
<p>æ™ºèƒ½æŒ‡é’ˆé€šå¸¸ä½¿ç”¨ <code>struct</code> å®ç°, å®ç°äº† <code>Deref</code> å’Œ <code>Drop</code> è¿™ä¸¤ä¸ª trait</p>
<p>Deref ä½¿å¾—æ™ºèƒ½æŒ‡é’ˆå¯ä»¥åƒå¼•ç”¨ä¸€æ ·ä½¿ç”¨</p>
<p>Drop å…è®¸è‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆç¦»å¼€ä½œç”¨åŸŸåçš„è¡Œä¸º</p>
<h3 id="boxt"><a class="header" href="#boxt"><code>Box&lt;T&gt;</code></a></h3>
<p>åœ¨ä¹‹å‰é—­åŒ…çš„æ—¶å€™æˆ‘ä»¬å°±è§è¿‡ <code>Box&lt;T&gt;</code> è¿™ä¸ªç±»å‹äº†</p>
<p>å¦‚æœæˆ‘ä»¬è¦è¿”å›ä¸€ä¸ªé—­åŒ…, æˆ‘ä»¬éœ€è¦ä½¿ç”¨ <code>Box&lt;T&gt;</code> æ¥åŒ…è£¹</p>
<p>Box çš„ä½œç”¨å°±æ˜¯æŠŠå†…å®¹æ”¾åˆ° Heap ä¸Šå­˜å‚¨, Box æŒ‡å‘äº† Heap ä¸Šçš„æ•°æ®</p>
<p>é€šå¸¸æˆ‘ä»¬ä½¿ç”¨ Box éƒ½æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦ä¸€ä¸ªçŸ¥é“ç¡®åˆ‡å¤§å°çš„å†…å®¹, ä½†æ˜¯å®é™…å¤§å°æ— æ³•ç¡®å®š</p>
<p>è¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ Box åŒ…è£¹, Box çš„å¤§å°æ˜¯ç¡®å®šçš„</p>
<p>æˆ–è€…æˆ‘ä»¬è¦è½¬ç§» <em>æ‰€æœ‰æƒ</em> åŒæ—¶ç¡®ä¿æ“ä½œæ•°æ®æ—¶æ•°æ®ä¸è¢«å¤åˆ¶</p>
<p>æ­¤å¤–å°±æ˜¯åœ¨æ³›å‹, æˆ‘ä»¬åªå…³å¿ƒå®ç°äº†æŸä¸€ç‰¹å®š trait, ä½†æ˜¯ä¸çŸ¥é“å…·ä½“ç±»å‹, å¯ä»¥ä½¿ç”¨ Box</p>
<p>è¿™æ˜¯ä½¿ç”¨ Box çš„ä¾‹å­, ä½¿ç”¨ <code>Box::new()</code></p>
<pre><code class="language-rust">fn main() {
    let b = Box::new(6);
    println!("b = {}", b);
}</code></pre>
<p>æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ Box æ¥å®ç°ç±»ä¼¼ Lisp çš„é“¾è¡¨ç±»å‹, å³é€’å½’ç±»å‹</p>
<pre><code class="language-rust">enum List&lt;T&gt; {
    Cons(T, Box&lt;List&lt;T&gt;&gt;),
    Nil,
}</code></pre>
<h3 id="deref-trait"><a class="header" href="#deref-trait"><code>Deref</code> trait</a></h3>
<p><code>Deref</code> è¿™ä¸ª trait æ˜¯ä¸€ä¸ª <strong>æ“ä½œç¬¦</strong>, å¯¹åº”çš„æ˜¯è§£å¼•ç”¨æ“ä½œç¬¦ <code>*</code></p>
<p>å®ç°è¿™ä¸ª trait, æˆ‘ä»¬å°±å¯ä»¥åƒå¼•ç”¨ä¸€æ ·æ¥å¤„ç†æˆ‘ä»¬çš„ç±»å‹</p>
<p>æ‰€ä»¥, å¦‚æœéœ€è¦ä» Box ä¸­å–å‡ºå€¼, å¯ä»¥ä½¿ç”¨ <code>*</code> æ¥å®ç°</p>
<pre><code class="language-rust">fn main() {
    let b = Box::new(6);
    assert_eq!(6, *b);
}</code></pre>
<p>ä»”ç»†çœ‹çš„è¯, ä¼šå‘ç° Box å®é™…ä¸Šå°±æ˜¯ä¸ª tuple struct</p>
<pre><code class="language-rust">
pub struct Box&lt;
    T: ?Sized,
    #[unstable(feature = "allocator_api", issue = "32838")] A: Allocator = Global,
&gt;(Unique&lt;T&gt;, A);</code></pre>
<p>åœ¨è§£å¼•ç”¨æ—¶, å¯¹äº <code>*b</code> è¿™ä¸ªæ“ä½œ, åœ¨ Box ç±»å‹ä¸Šä¼šå˜æˆ <code>*(b.deref())</code></p>
<p>å› ä¸º <code>deref</code> æ“ä½œåªä¼šè¿”å›å€¼çš„å¼•ç”¨, æ‰€ä»¥è¿˜éœ€è¦ä¸€ä¸ªæ™®é€šçš„è§£å¼•ç”¨æ‰èƒ½å®Œæˆè§£å¼•ç”¨æ“ä½œ</p>
<h4 id="deref-coercion"><a class="header" href="#deref-coercion">Deref Coercion</a></h4>
<p>å¦‚æœ T å®ç°äº† Deref, Deref Coercion ä¼šæŠŠ <strong>T çš„å¼•ç”¨</strong> è½¬å˜ä¸º T ç»è¿‡ Deref æ“ä½œåç”Ÿæˆçš„å¼•ç”¨</p>
<pre><code class="language-rust">fn main() {
    let p = Box::new(String::from("Kands"));
    hello(&amp;p);
}

fn hello(name: &amp;str) {
    println!("{}, hello!", name);
}

// &amp;p : &amp;Box&lt;String&gt;
//    =deref=&gt; &amp;String
//    =deref=&gt; &amp;str</code></pre>
<p>è¿™ä¸ªæ“ä½œæ˜¯åœ¨ç¼–è¯‘æ—¶è‡ªåŠ¨æ‰§è¡Œçš„, è¿è¡Œæ—¶æ²¡æœ‰ä»€ä¹ˆå¼€é”€</p>
<ul>
<li>å½“ <code>T: Deref&lt;Target=U&gt;</code>, å…è®¸ <code>&amp;T =&gt; &amp;U</code></li>
<li>å½“ <code>T: DerefMut&lt;Target=U&gt;</code>, å…è®¸ <code>&amp;mut T =&gt; &amp;mut U</code></li>
<li>å½“ <code>T: Deref&lt;Target=U&gt;</code>, å…è®¸ <code>&amp;mut T =&gt; &amp;U</code></li>
</ul>
<p>å¯¹äºå¯å˜å¼•ç”¨, è¿˜æœ‰ <code>DerefMut</code> è¿™æ ·ä¸€ä¸ª trait, æ˜¯ç±»ä¼¼çš„</p>
<h3 id="drop-trait"><a class="header" href="#drop-trait"><code>Drop</code> trait</a></h3>
<p>Drop trait å¯ä»¥è®©æˆ‘ä»¬è‡ªå®šä¹‰ç¦»å¼€ä½œç”¨åŸŸæ—¶çš„åŠ¨ä½œ, å¦‚èµ„æºçš„é‡Šæ”¾</p>
<p>è¦å®ç°è¿™ä¸ª trait, åªéœ€è¦å®ç° <code>drop(&amp;mut self)</code> æ–¹æ³•</p>
<p>Drop trait åœ¨ Prelude é‡Œ, ç±»ä¼¼ Cpp é‡Œçš„ææ„å‡½æ•°</p>
<p>ä¸€èˆ¬, drop æ–¹æ³•ä¸å…è®¸æˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨, ä½†æ˜¯æˆ‘ä»¬å¯ä»¥è°ƒç”¨ <code>std::mem::drop</code> æ–¹æ³•æ¥æå‰é‡Šæ”¾å€¼</p>
<h3 id="rct"><a class="header" href="#rct"><code>Rc&lt;T&gt;</code></a></h3>
<p><code>Rc&lt;T&gt;</code> æ˜¯å¼•ç”¨è®¡æ•°æ™ºèƒ½æŒ‡é’ˆ</p>
<p>æœ‰æ—¶ä¸€ä¸ªå€¼ä¼šæœ‰å¤šä¸ªæ‰€æœ‰è€…, å¦‚ å›¾é‡Œé¢çš„æŸä¸ªèŠ‚ç‚¹åŒæ—¶å±äºå¤šä¸ªè¾¹</p>
<p>å¦‚æœéœ€è¦åœ¨ Heap ä¸Šåˆ†é…æ•°æ®, å¹¶ä¸”è¿™ä¸ªæ•°æ®å°†è¢«ç¨‹åºçš„å¤šä¸ªéƒ¨åˆ†è¯»å–(åªè¯»), ä½†æ˜¯ä¸çŸ¥é“å“ªéƒ¨åˆ†ä¼šå…ˆç”¨å®Œæ•°æ®, åˆ™å¯ä»¥ä½¿ç”¨ <code>Rc&lt;T&gt;</code></p>
<p>ä½†æ˜¯è¦æ³¨æ„, <code>Rc&lt;T&gt;</code> æ˜¯ <strong>ä»…é€‚ç”¨äºå•çº¿ç¨‹çš„</strong></p>
<ul>
<li><code>Rc::clone(&amp;a)</code> å¢åŠ å¼•ç”¨è®¡æ•°</li>
<li><code>Rc::strong_count(&amp;a)</code> è·å¾—å¼•ç”¨è®¡æ•°
<ul>
<li>è¿˜æœ‰ <code>Rc::weak_count()</code></li>
</ul>
</li>
</ul>
<p>ä½¿ç”¨ä¾‹å­:</p>
<pre><code class="language-rust">use std::rc::Rc;

enum List&lt;T&gt; {
    Cons(T, Rc&lt;List&lt;T&gt;&gt;),
    Nil,
}

use List::*;

fn main() {
    // Rc(5 -&gt; 10 -&gt; nil)
    let a = Rc::new(Cons(5, Rc::new(Cons(10, Rc::new(Nil)))));
    println!("{}", Rc::strong_count(&amp;a));
    // =&gt; 1

    // 3 -&gt; a |=&gt; 3 -&gt; 5 -&gt; 10 -&gt; nil
    let b = Cons(3, Rc::clone(&amp;a));
    println!("{}", Rc::strong_count(&amp;a));
    // =&gt; 2

    // 4 -&gt; a |=&gt; 4 -&gt; 5 -&gt; 10 -&gt; nil
    let c = Cons(4, Rc::clone(&amp;a));
    println!("{}", Rc::strong_count(&amp;a));
    // =&gt; 3
}</code></pre>
<p><code>Rc::clone</code> ç›¸è¾ƒäº <code>clone()</code>, ä¸ä¼šæ‰§è¡Œæ•°æ®çš„æ·±åº¦æ‹·è´æ“ä½œ, åªä¼šå¢åŠ å¼•ç”¨è®¡æ•°, ç›¸å¯¹è¾ƒå¿«</p>
<p><code>Rc&lt;T&gt;</code> å®é™…ä¸Šæ˜¯ä½¿ç”¨ä¸å¯å˜å¼•ç”¨ä½¿å¾—æ•°æ®å¯ä»¥å…±äº«</p>
<h3 id="refcell"><a class="header" href="#refcell">RefCell</a></h3>
<p><code>Rc&lt;T&gt;</code> ä½¿ç”¨çš„æ˜¯ä¸å¯å˜å¼•ç”¨, å¦‚æœæˆ‘ä»¬éœ€è¦å¯¹å…±äº«çš„æ•°æ®è¿›è¡Œä¿®æ”¹</p>
<p>RefCell ä»£è¡¨äº†å…¶æŒæœ‰æ•°æ®çš„å”¯ä¸€æ‰€æœ‰æƒ, è€Œä¸”åªèƒ½åœ¨å•çº¿ç¨‹ä½¿ç”¨</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center"></th><th style="text-align: center"><code>Box&lt;T&gt;</code></th><th style="text-align: center"><code>Rc&lt;T&gt;</code></th><th style="text-align: center"><code>RefCell&lt;T&gt;</code></th></tr></thead><tbody>
<tr><td style="text-align: center">åŒä¸€æ•°æ®çš„æ‰€æœ‰è€…</td><td style="text-align: center">ä¸€ä¸ª</td><td style="text-align: center">å¤šä¸ª</td><td style="text-align: center">ä¸€ä¸ª</td></tr>
<tr><td style="text-align: center">å¯å˜æ€§, å€Ÿç”¨æ£€æŸ¥</td><td style="text-align: center">å¯å˜, ä¸å¯å˜å€Ÿç”¨ (ç¼–è¯‘æ—¶æ£€æŸ¥)</td><td style="text-align: center">ä¸å¯å˜å€Ÿç”¨ (ç¼–è¯‘æ—¶æ£€æŸ¥)</td><td style="text-align: center">å¯å˜, ä¸å¯å˜å€Ÿç”¨ (è¿è¡Œæ—¶æ£€æŸ¥)</td></tr>
</tbody></table>
</div>
<p>ä¾‹å­å¦‚ä¸‹</p>
<pre><code class="language-rust">pub trait Messager {
    fn send(&amp;self, msg: &amp;str);
}

pub struct LimitTracker&lt;'a, T: 'a + Messager&gt; {
    messager: &amp;'a T,
    value: usize,
    max: usize,
}

impl&lt;'a, T&gt; LimitTracker&lt;'a, T&gt;
where
    T: Messager,
{
    pub fn new(messager: &amp;T, max: usize) -&gt; LimitTracker&lt;T&gt; {
        LimitTracker {
            messager,
            value: 0,
            max,
        }
    }

    pub fn set_value(&amp;mut self, value: usize) {
        self.value = value;

        let percentage_of_max = self.value as f64 / self.max as f64;
        if percentage_of_max &gt;= 1.0 {
            self.messager.send("Error: You're over your quota!");
        } else if percentage_of_max &gt;= 0.9 {
            self.messager
                .send("Urgent warning: You've used up over 90% of your quota!");
        } else if percentage_of_max &gt;= 0.75 {
            self.messager
                .send("Warning: You've used up over 75% of your quota!");
        }
    }
}

#[cfg(test)]
mod tests {
    use super::*;
    use std::cell::RefCell;

    struct MockMessager {
        sent_messages: RefCell&lt;Vec&lt;String&gt;&gt;,
    }

    impl MockMessager {
        fn new() -&gt; MockMessager {
            MockMessager {
                sent_messages: RefCell::new(vec![]),
            }
        }
    }

    impl Messager for MockMessager {
        fn send(&amp;self, msg: &amp;str) {
            self.sent_messages.borrow_mut().push(String::from(msg));
        }
    }

    #[test]
    fn it_sends_an_over_75_persent_warning_message() {
        let mock_messager = MockMessager::new();
        let mut limit_tracker = LimitTracker::new(&amp;mock_messager, 100);

        limit_tracker.set_value(100);
        assert_eq!(mock_messager.sent_messages.borrow().len(), 1);
    }
}</code></pre>
<p>RefCell ä¼šè®°å½•å­˜åœ¨å¤šå°‘ä¸ªæ´»è·ƒçš„ <code>Ref&lt;T&gt;</code> å’Œ <code>RefMut&lt;T&gt;</code> æ™ºèƒ½æŒ‡é’ˆ, è¿™æ ·å°±ä¿è¯äº†å€Ÿç”¨è§„åˆ™</p>
<p>æˆ‘ä»¬è¿˜å¯ä»¥å°† RefCell å’Œ Rc ç»“åˆèµ·æ¥ä½¿ç”¨</p>
<pre><code class="language-rust">use std::{cell::RefCell, rc::Rc};

#[derive(Debug)]
enum List&lt;T&gt; {
    Cons(Rc&lt;RefCell&lt;T&gt;&gt;, Rc&lt;List&lt;T&gt;&gt;),
    Nil,
}

use List::*;

fn main() {
    // * -&gt; 5 -&gt; *
    let value = Rc::new(RefCell::new(5));
    // 5 -&gt; nil
    let a = Rc::new(Cons(Rc::clone(&amp;value), Rc::new(Nil)));
    // 6 -&gt; a |=&gt; 6 -&gt; 5 -&gt; nil
    let b = Cons(Rc::new(RefCell::new(6)), Rc::clone(&amp;a));
    // 10 -&gt; a |=&gt; 10 -&gt; 5 -&gt; nil
    let c = Cons(Rc::new(RefCell::new(10)), Rc::clone(&amp;a));

    println!("a = {:?}", a);
    println!("b = {:?}", b);
    println!("c = {:?}", c);
    /*
     * a = Cons(RefCell { value: 5 }, Nil)
     * b = Cons(RefCell { value: 6 }, Cons(RefCell { value: 5 }, Nil))
     * c = Cons(RefCell { value: 10 }, Cons(RefCell { value: 5 }, Nil))
     */

    *value.borrow_mut() += 10;

    println!("a = {:?}", a);
    println!("b = {:?}", b);
    println!("c = {:?}", c);
    /*
     * a = Cons(RefCell { value: 15 }, Nil)
     * b = Cons(RefCell { value: 6 }, Cons(RefCell { value: 15 }, Nil))
     * c = Cons(RefCell { value: 10 }, Cons(RefCell { value: 15 }, Nil))
     */
}</code></pre>
<p>é™¤æ­¤ä¹‹å¤–, æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ <code>Cell&lt;T&gt;</code> ä½¿ç”¨å¤åˆ¶æ•°æ®æ¥è®¿é—®æ•°æ®, <code>Mutex&lt;T&gt;</code> å®ç°äº†è·¨çº¿ç¨‹ä¸‹çš„å†…éƒ¨å¯å˜æ€§</p>
<h3 id="å¾ªç¯å¼•ç”¨å’Œå†…å­˜æ³„æ¼"><a class="header" href="#å¾ªç¯å¼•ç”¨å’Œå†…å­˜æ³„æ¼">å¾ªç¯å¼•ç”¨å’Œå†…å­˜æ³„æ¼</a></h3>
<p>Rust ä¹Ÿæ˜¯å¯ä»¥å‘ç”Ÿå†…å­˜æ³„æ¼çš„, å³ä½¿ç”¨ Rc å’Œ RefCell æœ‰å¯èƒ½å®ç°å¾ªç¯å¼•ç”¨, ä»è€Œå¯¼è‡´å†…å­˜æ³„æ¼</p>
<pre><code class="language-rust">use std::{cell::RefCell, rc::Rc};

#[derive(Debug)]
enum List&lt;T&gt; {
    Cons(T, RefCell&lt;Rc&lt;List&lt;T&gt;&gt;&gt;),
    Nil,
}

impl&lt;T&gt; List&lt;T&gt; {
    fn tail(&amp;self) -&gt; Option&lt;&amp;RefCell&lt;Rc&lt;List&lt;T&gt;&gt;&gt;&gt; {
        match self {
            Cons(_, item) =&gt; Some(item),
            Nil =&gt; None,
        }
    }
}

use List::*;

fn main() {
    let a = Rc::new(Cons(5, RefCell::new(Rc::new(Nil))));
    println!("a init rc count = {}", Rc::strong_count(&amp;a));
    println!("a next item = {:?}", a.tail());

    let b = Rc::new(Cons(10, RefCell::new(Rc::clone(&amp;a))));
    println!("a rc count = {}", Rc::strong_count(&amp;a));
    println!("b init rc count = {}", Rc::strong_count(&amp;b));
    println!("b next item = {:?}", b.tail());

    if let Some(link) = a.tail() {
        *link.borrow_mut() = Rc::clone(&amp;b);
    }

    println!("b rc count = {}", Rc::strong_count(&amp;b));
    println!("a rc count = {}", Rc::strong_count(&amp;a));
    // a  -&gt; 5
    // ^     |
    // |     v
    // 10 &lt;- b

    // println!("a next item = {:?}", a.tail());
    // thread 'main' has overflowed its stack
    // error: process didn't exit successfully:
    //   `target\debug\sp.exe` (exit code: 0xc00000fd, STATUS_STACK_OVERFLOW)
}</code></pre>
<p>ä¸Šé¢çš„ä¾‹å­é‡Œ, a å’Œ b å°±å½¢æˆäº†å¾ªç¯å¼•ç”¨, å¯¼è‡´äº†å†…å­˜æ³„æ¼</p>
<h4 id="weakt"><a class="header" href="#weakt"><code>Weak&lt;T&gt;</code></a></h4>
<p>é˜²æ­¢å¾ªç¯å¼•ç”¨å¯ä»¥ä½¿ç”¨ <code>Weak&lt;T&gt;</code></p>
<p><code>Rc::clone()</code> ä¸º <code>Rc&lt;T&gt;</code> å®ä¾‹çš„ <code>strong_count</code> åŠ ä¸€, <code>Rc&lt;T&gt;</code> çš„å®ä¾‹åªæœ‰åœ¨ <code>strong_count = 0</code> çš„æƒ…å†µä¸‹è¢«æ¸…ç†</p>
<p><code>Rc&lt;T&gt;</code> å®ä¾‹é€šè¿‡è°ƒç”¨ <code>Rc::downgrade</code> æ–¹æ³•å¯ä»¥åˆ›å»ºå€¼çš„ <em>Weak Reference</em></p>
<ul>
<li>è¿”å› <code>Weak&lt;T&gt;</code></li>
<li>è°ƒç”¨ <code>Rc::downgrade</code> ä¼šä¸º <code>weak_count</code> åŠ ä¸€</li>
</ul>
<p><code>Rc&lt;T&gt;</code> ä½¿ç”¨ <code>weak_count</code> æ¥è¿½è¸ªè¿˜æœ‰å¤šå°‘ <code>Weak&lt;T&gt;</code></p>
<p>ä½†æ˜¯ <code>weak_count</code> ä¸å½±å“ <code>Rc&lt;T&gt;</code> æ˜¯å¦è¢«æ¸…ç†, è€Œä¸”å¼±å¼•ç”¨ä¸æŒæœ‰æ‰€æœ‰æƒ, å¼ºå¼•ç”¨è®¡æ•°ä¸º 0 æ—¶, å°†è‡ªåŠ¨æ–­å¼€</p>
<p>åœ¨ä½¿ç”¨ <code>Weak&lt;T&gt;</code> å‰éœ€è¦ä¿è¯æŒ‡å‘çš„å€¼å­˜åœ¨, ä½¿ç”¨ <code>upgrade()</code> æ–¹æ³•å¯ä»¥è¿”å› <code>Option&lt;Rc&lt;T&gt;&gt;</code></p>
<pre><code class="language-rust">use std::cell::RefCell;
use std::rc::{Rc, Weak};

#[derive(Debug)]
struct Node&lt;T&gt; {
    value: T,
    parent: RefCell&lt;Weak&lt;Node&lt;T&gt;&gt;&gt;,
    children: RefCell&lt;Vec&lt;Rc&lt;Node&lt;T&gt;&gt;&gt;&gt;,
}

fn main() {
    let leaf = Rc::new(Node {
        value: 3,
        parent: RefCell::new(Weak::new()),
        children: RefCell::new(vec![]),
    });

    println!(
        "leaf strong = {}, weak = {}",
        Rc::strong_count(&amp;leaf),
        Rc::weak_count(&amp;leaf)
    );

    {
        let branch = Rc::new(Node {
            value: 5,
            parent: RefCell::new(Weak::new()),
            children: RefCell::new(vec![Rc::clone(&amp;leaf)]),
        });

        *leaf.parent.borrow_mut() = Rc::downgrade(&amp;branch);

        println!(
            "branch strong = {}, weak = {}",
            Rc::strong_count(&amp;branch),
            Rc::weak_count(&amp;branch)
        );

        println!(
            "leaf strong = {}, weak = {}",
            Rc::strong_count(&amp;leaf),
            Rc::weak_count(&amp;leaf)
        );
    }

    println!("leaf parent = {:?}", leaf.parent.borrow().upgrade());

    println!(
        "leaf strong = {}, weak = {}",
        Rc::strong_count(&amp;leaf),
        Rc::weak_count(&amp;leaf)
    );
}

/*
leaf strong = 1, weak = 0
branch strong = 1, weak = 1
leaf strong = 2, weak = 0
leaf parent = None
leaf strong = 1, weak = 0
*/</code></pre>
<hr />
<p>å¥½, ä»Šå¤©åˆ°æ­¤ä¸ºæ­¢, ä¹‹åå‡ å¤©å¤ä¹ æœŸæœ«, å°±æ‘¸äº†ï¼</p>
</main>
                        <nav class="nav-wrapper" aria-label="Page navigation">
                            <a rel="prev" href="../../notes/rust/20220623-rust-learn-12.html"
                                class="mobile-nav-chapters previous"
                                title="Previous chapter"
                                aria-label="Previous chapter"
                                aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next prefetch"
                                href="../../notes/rust/20220925-rust-learn-14.html"
                                class="mobile-nav-chapters next"
                                title="Next chapter" aria-label="Next chapter"
                                aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                            <div style="clear: both"></div>
                        </nav>
                    </div>
                </div>
                <div class="giscus-comment">
                </div>
                <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../notes/rust/20220623-rust-learn-12.html"
                        class="nav-chapters previous" title="Previous chapter"
                        aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next prefetch" href="../../notes/rust/20220925-rust-learn-14.html"
                        class="nav-chapters next" title="Next chapter"
                        aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                </nav>
            </div>
            <script>
                window.playground_copyable = true;
            </script>
            <script src="../../elasticlunr.min.js"></script>
            <script src="../../mark.min.js"></script>
            <script src="../../searcher.js"></script>
            <script src="../../clipboard.min.js"></script>
            <script src="../../highlight.js"></script>
            <script src="../../book.js"></script>
            <script src="../../theme/giscus.js"></script>
        </div>
    </body>
</html>
